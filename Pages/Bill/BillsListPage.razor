@page "/billslist"
@inject ProjectsDBContext db

<h3>Lista de Facturas</h3>

<AuthorizeView>
    <Authorized>

        <Tabs EnableFadeEffect="true">
            <Tab Title="Facturas Cargadas" Active="true">
                <Content>
                    <p>Facturas del año en curso</p>
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Id</th>
                                <th>Fecha</th>
                                <th>Cliente</th>
                                <th>Proyecto</th>
                                <th>Importe</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var bill in bills)
                            {
                                <tr>
                                    <td>@bill.BillDate.ToShortDateString()</td>
                                    <td>@bill.Project?.Title</td>
                                    <td>@bill.Project?.ProjectId</td>
                                    <td>@bill.Project.TaskNumber</td>
                                    <td>@bill.Project.CreationDate.ToShortDateString()</td>
                                    <td>@bill.Author</td>
                                    <td>@bill.Amount.ToString("N2")</td>

                                </tr>
                            }
                        </tbody>
                    </table>

                </Content>
            </Tab>
            <Tab Title="Estado de Proyectos">
                <Content>
                    <div class="p-1 d-flex flex-column">
                        <h3>Resumen de Facturas por Proyecto</h3>
                        <p>Facturas del año en curso y los ultimos 4 meses del anterior</p>
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Id</th>
                                    <th>Tarea</th>
                                    <th>Proyecto</th>
                                    <th>Estado</th>
                                    <th>Fecha de Proyecto</th>
                                    <th>Monto Registrado</th>
                                    <th>Total Facturado</th>
                                    <th>Porcentaje de Facturación</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in totalByProject)
                                {
                                    // Calcular el porcentaje asegurando que no haya excedentes
                                    var porcentaje = item.TotalAmount > 0 ? Math.Min((item.Amount / item.TotalAmount) * 100, 100) : 0;


                                    <tr>
                                        <td>
                                            <a href="/projects/@item.ProjectId" target="_blank">
                                                @item.ProjectId
                                            </a>
                                        </td>
                                        <td>
                                            <a href="https://grupomecsa.bitrix24.es/company/personal/user/107/tasks/task/view/@item.TaskNumber/" target="_blank">
                                                @item.TaskNumber
                                            </a>
                                        </td>
                                        <td>@item.ProjectName</td>
                                        <td>@item.status</td>
                                        <td>@item.CreationDate.ToShortDateString()</td>
                                        <td>@item.Amount.ToString("N2")</td>
                                        <td>@item.TotalAmount.ToString("N2")</td>
                                        <td>

                                            <Progress Class="mb-3">
                                                <ProgressBar Width="@double.Parse(porcentaje.ToString())" Label="@porcentaje.ToString("N2")" />
                                            </Progress>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </Content>
            </Tab>
            <Tab Title="Sin Facturación">
                <Content>
                    <p>Facturas del año en curso</p>
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Id</th>
                                <th>Tarea</th>
                                <th>Proyecto</th>
                                <th>Fecha de Creación</th>
                                <th>Monto Registrado</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in projectsWithoutBilling)
                            {
                                <tr>


                                    <td>
                                        <a href="/projects/@item.ProjectId" target="_blank">
                                            @item.ProjectId
                                        </a>
                                    </td>
                                    <td>
                                        <a href="https://grupomecsa.bitrix24.es/company/personal/user/107/tasks/task/view/@item.TaskNumber/" target="_blank">
                                            @item.TaskNumber
                                        </a>
                                    </td>
                                    <td>@item.ProjectName</td>
                                    <td>@item.status</td>
                                    <td>@item.CreationDate.ToShortDateString()</td>
                                    <td>@item.Amount.ToString("N2")</td>
                                    <td>No Facturado</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </Content>
            </Tab>

        </Tabs>
    </Authorized>
    <NotAuthorized>
        <ErrorViewComponent />
    </NotAuthorized>
</AuthorizeView>



@code {

    List<Bill> bills = new List<Bill>();
    List<ProjectBillSummary> totalByProject = new List<ProjectBillSummary>();


    protected override Task OnInitializedAsync()
    {
        bills = db.Bill.AsNoTracking().Include(e => e.Project).OrderByDescending(e => e.BillDate).ToList();

        GetAmountBillByProject();
        GetProjectsWithoutBilling(); // Obtener los proyectos sin facturar

        return base.OnInitializedAsync();
    }


    private async Task GetAmountBillByProject()
    {
        var currentYear = DateTime.Now.Year;  // Año actual
        var lastYear = currentYear - 1;       // Año anterior

        // Obtener las fechas de inicio para los filtros
        var startDateCurrentYear = new DateTime(currentYear, 1, 1);  // 1 de enero del año en curso
        var startDateLastYear = new DateTime(lastYear, 9, 1);       // 1 de septiembre del año anterior

        // Filtrar las facturas que están en el rango de fechas adecuado
        totalByProject = db.Bill.Include(e => e.Project)
        .Include(e => e.Project.State)
            .Where(b => (b.BillDate >= startDateCurrentYear && b.BillDate <= DateTime.Now) ||
                        (b.BillDate >= startDateLastYear && b.BillDate < new DateTime(lastYear, 12, 31)))
            .GroupBy(b => b.Project.ProjectId)
            .Select(g => new ProjectBillSummary
                {
                    ProjectId = g.Key,
                    TaskNumber = g.First().Project.TaskNumber,
                    CreationDate = g.First().Project.CreationDate,
                    Amount = g.First().Project.Amount,
                    status = g.First().Project.State.StateName,
                    ProjectName = g.First().Project.Title,
                    TotalAmount = g.Sum(b => b.Amount)
                })
                .OrderByDescending(e => e.ProjectId)
            .ToList();
    }


    List<ProjectBillSummary> projectsWithoutBilling = new List<ProjectBillSummary>();

    private async Task GetProjectsWithoutBilling()
    {
        var currentYear = DateTime.Now.Year;

        // Filtrar los proyectos que no tienen facturación registrada
        projectsWithoutBilling = await db.Projects
        .Include(e => e.State)
        .AsNoTracking()
            .Where(p => p.CreationDate.Year == currentYear && !db.Bill.Any(b => b.ProjectId == p.ProjectId)) // Proyectos sin facturas
            .Select(p => new ProjectBillSummary
                {
                    ProjectId = p.ProjectId,
                    ProjectName = p.Title,
                    CreationDate = p.CreationDate,
                    Amount = p.Amount,
                    TaskNumber = p.TaskNumber,
                    status = p.State.StateName,
                    TotalAmount = 0 // No hay facturación registrada
                })
                .OrderByDescending(e => e.ProjectId)
            .ToListAsync(); // Se usa ToListAsync para trabajar de manera asincrónica
    }





    public class ProjectBillSummary
    {
        public int ProjectId { get; set; }
        public string ProjectName { get; set; }
        public DateTime CreationDate { get; set; }
        public decimal Amount { get; set; }
        public decimal TotalAmount { get; set; }
        public string TaskNumber { get; set; }
        public string status { get; set; }
    }

}
