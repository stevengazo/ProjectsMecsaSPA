@inject ProjectsDBContext db

@page "/projects/{id}"
@using Microsoft.EntityFrameworkCore


<h3>Detalles del Proyecto</h3>
@if (project.IsDeleted)
{
    <h3 class="text-danger">
        Este proyecto fue marcado como inactivo
    </h3>
    <p class="text-danger">
        Este proyecto no aparecerá en la zona Kanban de planificación. Además no podrá ingresar nueva información
    </p>
}

<div class="container">
    <div class="row">
        <!-- Detalles del Proyecto -->
        <div class=" shadow p-1 border rounded ">
            <DetailsProjectTableComponent project="project" />
        </div>
    </div>
    <div class="row mt-3 shadow p-1 border rounded ">
        <Tabs EnableFadeEffect="true">
            <Tab Title="Archivos" Active="true">
                <Content>
                    @if (!project.IsDeleted)
                    {
                        <UploadFileComponent id="project.ProjectId" />
                    }
                    <FileManagementComponent id="project.ProjectId" />
                </Content>
            </Tab>
            <Tab Title="Facturas">
                <Content>
                    <div class="p-1">
                        <AddBillComponent ProjectId="project.ProjectId" OnAdded="UpdateCommentaries" />
                       
                    </div>
                </Content>
            </Tab>
            <Tab Title="Comentarios">
                <Content>
                    <div class="overflow-auto">
                        <h5>Comentarios</h5>
                        @if (!project.IsDeleted)
                        {
                            <CommentaryAddComponent ProjectId="project.ProjectId" OnAdded="UpdateCommentaries" />
                        }
                        <div class="d-flex flex-column overflow">
                            @foreach (var i in project.Commentaries)
                            {
                                <div class="mx-2 my-1 p-2 border rounded">
                                    <label>@i.CreationDate.ToLongDateString() @i.Author</label>
                                    <p>@i.CommentaryText</p>
                                </div>
                            }
                        </div>
                    </div>
                </Content>
            </Tab>
        </Tabs>
    </div>
</div>



@code {
    [Parameter]
    public string id { get; set; }

    public Project project = new();

    public int _id;

    protected override async Task OnInitializedAsync()
    {
        base.OnInitializedAsync();
        var d = int.TryParse(id, out _id);
        if (d)
        {
            project = db.Projects
            .Include(e => e.State)
            .Include(e => e.Type)
            .Include(e => e.Customer)
            .Include(e => e.Commentaries)
            .Include(e => e.Seller)
            .FirstOrDefault(i => i.ProjectId == _id);
            project.Commentaries = project.Commentaries.OrderByDescending(i => i.CommentaryID).ToList();

        }
    }

    public async Task UpdateCommentaries()
    {
        project.Commentaries = db.Comments.Where(i => i.ProjectId == project.ProjectId).ToList();
    }

    public async Task UpdateBills()
    {
        project.Bills = db.Bill.Where(i => i.ProjectId == project.ProjectId).ToList();
    }
}
