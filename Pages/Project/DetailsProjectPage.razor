@inject ProjectsDBContext db
@page "/projects/{id}"
@using Microsoft.EntityFrameworkCore

<Offcanvas @ref="offcanvas" />


<h3 class="text-center">Detalles del Proyecto</h3>
@if (project.IsDeleted)
{
    <h3 class="text-danger">
        Este proyecto fue marcado como inactivo
    </h3>
    <p class="text-danger">
        Este proyecto no aparecerá en la zona Kanban de planificación. Además no podrá ingresar nueva información
    </p>
}

<div class="container pb-5">
    <div class="row">
        <!-- Detalles del Proyecto -->
        <div class=" shadow p-1 border rounded ">
            <AuthorizeView>
                <Authorized>
                    <DetailsProjectTableComponent project="project" />
                </Authorized>
            </AuthorizeView>
        </div>
    </div>
    <div class="row mt-2 shadow p-1 border rounded ">
        <Tabs EnableFadeEffect="true">
            <Tab Title="Archivos" Active="true">
                <Content>
                    <AuthorizeView Roles="administrador,ingeniero,asistente ,contabilidad,vendedor">
                        <Authorized>
                            @if (!project.IsDeleted)
                            {
                                <div class="border rounded rounded-sm shadow p-1 m-1">
                                    <UploadFileComponent id="project.ProjectId" />
                                </div>
                            }
                        </Authorized>
                    </AuthorizeView>

                    <AuthorizeView >
                        <Authorized>
                            <div class="border rounded rounded-sm shadow p-1 mx-1 my-3">
                                <FileManagementComponent id="project.ProjectId" />
                            </div>
                        </Authorized>
                    </AuthorizeView>

                </Content>
            </Tab>
            <Tab Title="Facturas">
                <Content>
                    <div class="py-3 px-1 d-flex flex-column">

                        <AuthorizeView Roles="administrador,contabilidad">
                            <Authorized>
                                <div class="">
                                    <button @onclick="ShowAddBill" class="btn btn-outline-success">
                                        Agregar Factura
                                    </button>
                                </div>
                            </Authorized>
                        </AuthorizeView>
                        <AuthorizeView >
                            <Authorized>
                                <div>
                                    <BillTableComponent Bills="project.Bills.ToList()" />
                                </div>
                            </Authorized>
                        </AuthorizeView>
                    </div>
                </Content>
            </Tab>
            <Tab Title="Comentarios">
                <Content>
                    <div class="overflow-auto py-3">
                        <AuthorizeView Roles="administrador,ingeniero,asistente ,contabilidad">
                            <Authorized>
                                <div class=" my-2">
                                    <h5>Nuevo Comentario</h5>
                                    @if (!project.IsDeleted)
                                    {
                                        <CommentaryAddComponent ProjectId="project.ProjectId" OnAdded="UpdateCommentaries" />
                                    }
                                </div>
                            </Authorized>
                        </AuthorizeView>
                        <div class="d-flex flex-column overflow">
                            <h5>Comentarios</h5>
                            @foreach (var i in project.Commentaries)
                            {
                                <div class="m-0.5 py-1 px-2 border rounded">
                                    <div class="d-flex flex-row justify-content-between">
                                        <label style="font-size:16px;">@i.Author</label>
                                        <label style="font-size:15px">@i.CreationDate.ToString("dd MMM yy")</label>
                                    </div>
                                    <hr class="p-0 mx-0 my-2" />
                                    <p class="text-muted my-3" style="font-size:14px; white-space: pre-line;">
                                        @i.CommentaryText
                                    </p>
                                </div>
                            }
                        </div>
                    </div>
                </Content>
            </Tab>
        </Tabs>
    </div>
</div>




@code {
    [Parameter]
    public string id { get; set; }

    public Project project = new();

    public int _id;

    private Offcanvas offcanvas = default!;
    private InfiniteScrollProjects infiniteScrollProjects = default!;

    protected override async Task OnInitializedAsync()
    {
        base.OnInitializedAsync();
        var d = int.TryParse(id, out _id);
        if (d)
        {
            project = db.Projects
            .AsNoTracking()
            .Include(e => e.State)
            .Include(e => e.Type)
            .Include(e => e.Customer)
            .Include(e => e.Commentaries)
            .Include(e => e.Seller)
            .Include(e => e.Bills)
            .FirstOrDefault(i => i.ProjectId == _id);
            project.Commentaries = project.Commentaries.OrderByDescending(i => i.CommentaryID).ToList();

        }
    }

    public async Task UpdateCommentaries()
    {
        project.Commentaries = db.Comments.AsNoTracking().Where(i => i.ProjectId == project.ProjectId).ToList();
    }

    public async Task UpdateBills()
    {
        project.Bills = db.Bill
                            .AsNoTracking()
                            .Where(i => i.ProjectId == project.ProjectId)
                            .ToList();
    }
    public async Task ShowAddBill()
    {

        var parameters = new Dictionary<string, object>
        {

            { nameof(AddBillComponent.OnAdded), EventCallback.Factory.Create(this, RefreshBills) },
             { "ProjectId", project.ProjectId },
             { "CurrencyType", project.CurrencyType }
        };

        // Mostrar el componente AddProject dentro del Offcanvas
        // El primer parámetro es el título del Offcanvas
        // El segundo parámetro es el diccionario de parámetros que contiene el EventCallback
        await offcanvas.ShowAsync<AddBillComponent>("Agregar Información de Factura", parameters);
    }

    public async Task RefreshBills()
    {
        await offcanvas.HideAsync();
        StateHasChanged();
        project.Bills.Clear();
        project.Bills = db.Bill.AsNoTracking().Where(i => i.ProjectId == _id).ToList();
        StateHasChanged();

    }
}
