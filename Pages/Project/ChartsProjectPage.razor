@page "/chartsprojects"
@inject ProjectsDBContext db

<h3>Proyectos por Estado</h3>

<BarChart @ref="barChart" Width="800" Height="600" />

<div class="mt-5">
    <Button Type="ButtonType.Button" Color="ButtonColor.Primary" Size="ButtonSize.Small" @onclick="async () => await UpdateChartAsync()">Actualizar Gráfico</Button>
</div>

@code {
    private BarChart barChart = default!;
    private BarChartOptions barChartOptions = default!;
    private ChartData chartData = default!;

    protected override async Task OnInitializedAsync()
    {
        await UpdateChartAsync();
    }

    private async Task UpdateChartAsync()
    {
        var projectCountsInMemory = await GetProjectCountsAsync();
        var genericData = GetGenericData();

        chartData = PrepareChartData(projectCountsInMemory, genericData);
        barChartOptions = PrepareChartOptions();

        await barChart.UpdateAsync(chartData, barChartOptions);
    }

    private async Task<Dictionary<string, int>> GetProjectCountsAsync()
    {
        var projects = await db.Projects.ToListAsync();
        var states = await db.States.ToListAsync();

        return projects
            .Join(
                states,
                p => p.StateId,
                s => s.StateId,
                (p, s) => new { p.StateId, s.StateName }
            )
            .GroupBy(p => p.StateName)
            .Select(g => new { State = g.Key, Count = g.Count() })
            .ToDictionary(x => x.State, x => x.Count);
    }

    private Dictionary<string, int> GetGenericData()
    {
        return new Dictionary<string, int>
        {
            { "Estado A", 10 },
            { "Estado B", 20 },
            { "Estado C", 15 },
            { "Estado D", 25 }
        };
    }

    private ChartData PrepareChartData(Dictionary<string, int> projectCountsInMemory, Dictionary<string, int> genericData)
    {
        return new ChartData
            {
                Labels = projectCountsInMemory.Keys.ToList(),
                Datasets = new List<IChartDataset>
            {
                new BarChartDataset
                {
                    Label = "Proyectos por Estado",
                    Data = projectCountsInMemory.Values.Select(v => (double?)v).ToList(),
                    BackgroundColor = new List<string> { "#42a5f5" },
                    BorderColor = new List<string> { "#1e88e5" },
                    BorderWidth = new List<double> { 1 }
                },
                new BarChartDataset
                {
                    Label = "Datos Genéricos",
                    Data = genericData.Values.Select(v => (double?)v).ToList(),
                    BackgroundColor = new List<string> { "#66bb6a" },
                    BorderColor = new List<string> { "#43a047" },
                    BorderWidth = new List<double> { 1 }
                }
            }
            };
    }

    private BarChartOptions PrepareChartOptions()
    {
        return new BarChartOptions
            {
                Responsive = true,
                Interaction = new Interaction { Mode = InteractionMode.Index }
            };
    }
}
