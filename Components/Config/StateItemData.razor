@inject IDbContextFactory<ProjectsDBContext> DbContextFactory

<div class="card shadow-sm border-0 p-2 my-1">
    <div class="d-flex justify-content-between align-items-center">

        <!-- Información -->
        <div class="d-flex align-items-center gap-3">
            <span class="badge bg-success shadow-sm px-3 py-2">
                @StateItem.OrderPriority
            </span>

            <span class="fw-semibold text-muted">
                @StateItem.StateName
            </span>
        </div>

        <!-- Acciones -->
        <div>
            @if (CanEdit)
            {
                <EditForm Model="@StateItem"
                          OnValidSubmit="EditState"
                          class="d-flex align-items-center gap-2">

                    <DataAnnotationsValidator />

                    <InputText class="form-control form-control-sm"
                               @bind-Value="StateItem.StateName"
                               placeholder="Nombre"
                               style="width: 180px;" />

                    <InputNumber class="form-control form-control-sm"
                                 @bind-Value="StateItem.OrderPriority"
                                 placeholder="Prioridad"
                                 style="width: 90px;" />

                    <button type="submit"
                            class="btn btn-sm btn-outline-success">
                        ✔
                    </button>

                    <button type="button"
                            class="btn btn-sm btn-outline-secondary"
                            @onclick="() => CanEdit = false">
                        ✖
                    </button>
                </EditForm>

                @if (!string.IsNullOrEmpty(ErrorMessage))
                {
                    <div class="text-danger small mt-1">
                        @ErrorMessage
                    </div>
                }
            }
            else
            {
                <button class="btn btn-sm btn-outline-primary"
                        @onclick="() => CanEdit = true">
                    ✎
                </button>
            }
        </div>

    </div>
</div>

@code {
    [Parameter]
    public State StateItem { get; set; }

    private ProjectsDBContext db;

    private bool CanEdit { get; set; } = false;
    private string ErrorMessage { get; set; }

    protected override async Task OnInitializedAsync()
    {
        db = DbContextFactory.CreateDbContext();
    }

    async Task EditState()
    {
        // Verifica si ya existe un estado con el mismo OrderPriority
        var exist = db.States.FirstOrDefault(e => e.OrderPriority == StateItem.OrderPriority && e.StateId != StateItem.StateId);

        // Verifica que el nombre del estado no esté vacío y que el número de prioridad no esté duplicado
        if (string.IsNullOrEmpty(StateItem.StateName))
        {
            ErrorMessage = "El nombre del estado es obligatorio.";
        }
        else if (exist != null)
        {
            ErrorMessage = "El número de prioridad ya está asignado a otro estado.";
        }
        else
        {
            ErrorMessage = null; // Limpiar el mensaje de error
            db.States.Update(StateItem);
            await db.SaveChangesAsync();
            CanEdit = false;
        }
    }
}
