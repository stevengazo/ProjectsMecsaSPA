@inject IDbContextFactory<ProjectsDBContext> DbContextFactory


<div class="border rounded shadow-sm p-3 mb-3">

    <h6 class="fw-bold mb-3">Estados</h6>

    <EditForm Model="@StateNew">
        <div class="row g-2 align-items-end">

            <div class="col-md-6">
                <div class="form-floating">
                    <InputText id="StateName"
                               class="form-control form-control-sm shadow-sm"
                               @bind-Value="StateNew.StateName" />
                    <label for="StateName">Nombre del Estado</label>
                </div>
            </div>

            <div class="col-md-3">
                <button type="button"
                        class="btn btn-sm btn-outline-success w-100"
                        @onclick="AddCompanyAsync">
                    Agregar
                </button>
            </div>

        </div>
    </EditForm>
</div>

<div class="mt-3">
    @foreach (var i in stateList)
    {
        <StateItemData stateItem="@i" />
    }
</div>


@code {
    List<State> stateList = new List<State>();
    ProjectsDBContext db;

    private State StateNew { get; set; }

    protected override async Task OnInitializedAsync()
    {
		db = DbContextFactory.CreateDbContext();
        StateNew = new State();
        stateList = await db.States.AsNoTracking().ToListAsync();
    }

    async Task AddCompanyAsync()
    {
        if (!string.IsNullOrEmpty(StateNew.StateName))
        {
            StateNew.OrderPriority = db.States.OrderByDescending(e => e.OrderPriority).FirstOrDefault()?.OrderPriority + 1 ?? 1;
            db.States.Add(StateNew);
            await db.SaveChangesAsync(); 
            stateList.Add(StateNew);
            StateNew = new State();
            StateHasChanged(); 
        }
    }
}
