@page "/configuracion"
@using System.Text.Json
@inject IConfiguration Configuration
@inject IWebHostEnvironment Env

<h3 class="mb-3">Configuración</h3>

@if (settings != null)
{
    <EditForm Model="settings" OnValidSubmit="GuardarCambios">
        <DataAnnotationsValidator />

        <!-- BANCO CENTRAL -->
        <div class="card shadow-sm mb-3">
            <div class="card-body">
                <h5 class="card-title">Banco Central</h5>
                <p class="text-muted small">
                    Datos básicos para conexión con el API del Banco Central de Costa Rica
                </p>

                <div class="row g-2">
                    <div class="col-md-6">
                        <div class="form-floating">
                            <InputText class="form-control"
                                       id="bcNombre"
                                       @bind-Value="settings.BancoCentral.Nombre" />
                            <label for="bcNombre">Nombre</label>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-floating">
                            <InputText class="form-control"
                                       id="bcCorreo"
                                       @bind-Value="settings.BancoCentral.CorreoElectronico" />
                            <label for="bcCorreo">Correo electrónico</label>
                        </div>
                    </div>

                    <div class="col-md-12">
                        <div class="form-floating">
                            <InputText class="form-control"
                                       id="bcToken"
                                       @bind-Value="settings.BancoCentral.Token" />
                            <label for="bcToken">Token</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TELEGRAM -->
        <div class="card shadow-sm mb-3">
            <div class="card-body">
                <h5 class="card-title">Telegram</h5>
                <p class="text-muted small">
                    Datos para conexión con el bot de Telegram
                </p>

                <div class="form-floating">
                    <InputText class="form-control"
                               id="telegramToken"
                               @bind-Value="settings.TelegramSettings.BotToken" />
                    <label for="telegramToken">Bot Token</label>
                </div>
            </div>
        </div>

        <!-- SMTP -->
        <div class="card shadow-sm mb-3">
            <div class="card-body">
                <h5 class="card-title">SMTP</h5>
                <p class="text-muted small">
                    Datos básicos para el envío de correo electrónico
                </p>

                <div class="row g-2">
                    <div class="col-md-6">
                        <div class="form-floating">
                            <InputText class="form-control"
                                       id="smtpHost"
                                       @bind-Value="settings.Smtp.Host" />
                            <label for="smtpHost">Host</label>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="form-floating">
                            <InputNumber class="form-control"
                                         id="smtpPort"
                                         @bind-Value="settings.Smtp.Port" />
                            <label for="smtpPort">Puerto</label>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-floating">
                            <InputText class="form-control"
                                       id="smtpUser"
                                       @bind-Value="settings.Smtp.Username" />
                            <label for="smtpUser">Usuario</label>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-floating">
                            <InputText type="password"
                                       class="form-control"
                                       id="smtpPassword"
                                       @bind-Value="settings.Smtp.Password" />
                            <label for="smtpPassword">Contraseña</label>
                        </div>
                    </div>

                    <div class="col-md-12">
                        <div class="form-check mt-2">
                            <InputCheckbox class="form-check-input"
                                           id="smtpSsl"
                                           @bind-Value="settings.Smtp.EnableSsl" />
                            <label class="form-check-label" for="smtpSsl">
                                Habilitar SSL
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ACCIÓN -->
        <div class="d-flex justify-content-end">
            <button type="submit"
                    class="btn btn-outline-primary px-4">
                Guardar cambios
            </button>
        </div>
    </EditForm>
}


@code {
    private AppSettings settings;

    protected override void OnInitialized()
    {
        // Lee la configuración directamente desde el archivo appsettings.json

        var d = Configuration.Get<AppSettings>();
        settings = d;
    }


    private async Task GuardarCambios()
    {
        var filePath = Path.Combine(Env.ContentRootPath, "appsettings.json");
        var json = JsonSerializer.Serialize(new { AppSettings = settings }, new JsonSerializerOptions { WriteIndented = true });

        // Guarda el archivo appsettings.json con los cambios
        await File.WriteAllTextAsync(filePath, json);
    }

    public class AppSettings
    {
        public BancoCentral BancoCentral { get; set; } = new();
        public TelegramSettings TelegramSettings { get; set; } = new();
        public Smtp Smtp { get; set; } = new();
    }

    public class BancoCentral
    {
        public string Nombre { get; set; }
        public string CorreoElectronico { get; set; }
        public string Token { get; set; }
    }

    public class TelegramSettings
    {
        public string BotToken { get; set; }
    }

    public class Smtp
    {
        public string Host { get; set; }
        public int Port { get; set; }
        public string Username { get; set; }
        public string Password { get; set; }
        public bool EnableSsl { get; set; }
    }
}
