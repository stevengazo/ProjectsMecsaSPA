@using Microsoft.AspNetCore.Identity
@inject ApplicationDbContext dbContext;
@inject ProjectsDBContext db;



<div class="border rounded shadow-sm p-3 mt-4 mb-4">

    <!-- PERFIL VENDEDOR -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="fw-bold mb-0">Perfil de Vendedor</h5>

        @if (seller != null)
        {
            <button class="btn btn-sm btn-outline-@(seller.IsActive ? "danger" : "success")"
                    @onclick="seller.IsActive? DisableSeller : SuscribeSeller">
                @(seller.IsActive ? "Desactivar Vendedor" : "Activar como Vendedor")
            </button>
        }
        else
        {
            <button class="btn btn-sm btn-outline-success"
                    @onclick="SuscribeSeller">
                Activar como Vendedor
            </button>
        }
    </div>

    @if (seller != null)
    {
        <div class="small text-muted">
            Estado actual:
            <span class="fw-semibold @(seller.IsActive ? "text-success" : "text-danger")">
                @(seller.IsActive ? "Activo" : "Inactivo")
            </span>
        </div>
    }
</div>

<!-- ROLES -->
<div class="border rounded shadow-sm p-3">

    <h5 class="fw-bold mb-3">Gestión de Roles</h5>

    <div class="row g-2 align-items-end mb-3">
        <div class="col-md-6">
            <label class="form-label small fw-semibold">Roles disponibles</label>
            <select class="form-select form-select-sm shadow-sm"
                    @bind="idSelected">
                @foreach (var role in Roles)
                {
                    <option value="@role.Id">@role.Name</option>
                }
            </select>
        </div>

        <div class="col-md-3">
            <button class="btn btn-sm btn-outline-info w-100"
                    @onclick="AddRol">
                Agregar Rol
            </button>
        </div>
    </div>

    <table class="table table-sm table-hover align-middle">
        <thead class="table-light">
            <tr>
                <th>Rol Asignado</th>
                <th class="text-end">Acciones</th>
            </tr>
        </thead>
        <tbody>
            @if (!usedRoles.Any())
            {
                <tr>
                    <td colspan="2" class="text-center text-muted small">
                        No hay roles asignados
                    </td>
                </tr>
            }
            else
            {
                @foreach (var role in usedRoles)
                {
                    <tr>
                        <td>
                            <span class="fw-semibold">@role.Name</span>
                        </td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-danger"
                                    @onclick="() => RemoveRole(role.Id)">
                                Eliminar
                            </button>
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>
</div>




@code {
    [Parameter]
    public string Id { get; set; }
    private string idSelected = "";
    private List<IdentityUserRole<string>> userRoles = new();
    private List<IdentityRole> usedRoles = new();
    private List<IdentityRole> Roles = new();

    private UserIdentityEx user = new();
    private Seller seller = null;

    protected override async Task OnInitializedAsync()
    {
        user = dbContext.Users.FirstOrDefault(e => e.Id == Id);
        Roles = dbContext.Roles.ToList();
        await LoadUserRoles();
        await base.OnInitializedAsync();
    }

    private async Task LoadUserRoles()
    {
        if (user != null)
        {
            userRoles = dbContext.UserRoles
                .Where(e => e.UserId == Id)
                .ToList();

            var roleIds = userRoles.Select(ur => ur.RoleId).ToList();

            usedRoles = dbContext.Roles
                .Where(r => roleIds.Contains(r.Id))
                .ToList();

            seller = await db.Seller.FirstOrDefaultAsync(e => e.SellerId == user.DNI);
        }
    }

    private async Task AddRol()
    {
        if (!string.IsNullOrEmpty(idSelected))
        {
            var identityUserRole = new IdentityUserRole<string>
                {
                    UserId = Id,
                    RoleId = idSelected
                };
            dbContext.UserRoles.Add(identityUserRole);
            await dbContext.SaveChangesAsync();
            await LoadUserRoles();
            StateHasChanged();
        }
    }

    private async Task RemoveRole(string roleId)
    {
        var userRole = userRoles.FirstOrDefault(ur => ur.RoleId == roleId && ur.UserId == Id);
        if (userRole != null)
        {
            dbContext.UserRoles.Remove(userRole);
            await dbContext.SaveChangesAsync();
            await LoadUserRoles();
            StateHasChanged();
        }
    }

    private async Task DisableSeller()
    {
        seller.IsActive = false;
        db.Seller.Update(seller);
        await db.SaveChangesAsync();
    }

    private async Task SuscribeSeller()
    {
        try
        {
            seller = db.Seller.FirstOrDefault(w => w.SellerId == user.DNI);
            if (seller == null)
            {
                seller = new Seller
                    {
                        SellerId = user.DNI,
                        SellerName = $"{user.Name} {user.LastName}",
                        Email = user.Email,
                        DNI = user.DNI,
                        IsActive = true
                    };
                using (var transaction = await db.Database.BeginTransactionAsync())
                {
                    db.Database.ExecuteSqlRaw("SET IDENTITY_INSERT [dbo].[Seller] ON");
                    db.Seller.Add(seller);
                    await db.SaveChangesAsync();
                    db.Database.ExecuteSqlRaw("SET IDENTITY_INSERT [dbo].[Seller] OFF");
                    await transaction.CommitAsync();
                }
            }
            else
            {
                seller.IsActive = true;
                db.Seller.Update(seller);
                await db.SaveChangesAsync();
            }
        }
        catch (Exception rtg)
        {
            
            throw;
        }
    }
}
