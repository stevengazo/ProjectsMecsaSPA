@using Microsoft.AspNetCore.Identity
@inject ApplicationDbContext dbContext;
@inject ProjectsDBContext db;

@if (seller != null)
{
    <button class="ml-1 btn btn-sm btn-outline-@(seller.IsActive ? "danger" : "info")"
            @onclick="seller.IsActive ? DisableSeller : SuscribeSeller">
        @(seller.IsActive ? "Eliminar como Vendedor" : "Suscribir como Vendedor")
    </button>
}
else
{
    <button class="ml-1 btn btn-sm btn-outline-info" @onclick="SuscribeSeller">
        Suscribir como Vendedor
    </button>
}

<h3>Roles</h3>

<div class="d-flex flex-row gap-2 h-50">
    <label>Roles</label>
    <select class="form-control-sm" @bind="idSelected">
        @foreach (var role in Roles)
        {
            <option value="@role.Id">@role.Name</option>
        }
    </select>
    <button class="btn btn-outline-info" @onclick="AddRol">Agregar Rol</button>
</div>

<table class="table">
    <thead>
        <tr>
            <th>Rol</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var role in usedRoles)
        {
            <tr>
                <td>@role.Name</td>
                <td>
                    <button class="btn btn-sm btn-outline-danger" @onclick="() => RemoveRole(role.Id)">Eliminar</button>
                </td>
            </tr>
        }
    </tbody>
</table>

@code {
    [Parameter]
    public string Id { get; set; }
    private string idSelected = "";
    private List<IdentityUserRole<string>> userRoles = new();
    private List<IdentityRole> usedRoles = new();
    private List<IdentityRole> Roles = new();

    private UserIdentityEx user = new();
    private Seller seller = null;

    protected override async Task OnInitializedAsync()
    {
        user = dbContext.Users.FirstOrDefault(e => e.Id == Id);
        Roles = dbContext.Roles.ToList();
        await LoadUserRoles();
        await base.OnInitializedAsync();
    }

    private async Task LoadUserRoles()
    {
        if (user != null)
        {
            userRoles = dbContext.UserRoles
                .Where(e => e.UserId == Id)
                .ToList();

            var roleIds = userRoles.Select(ur => ur.RoleId).ToList();

            usedRoles = dbContext.Roles
                .Where(r => roleIds.Contains(r.Id))
                .ToList();

            seller = await db.Seller.FirstOrDefaultAsync(e => e.SellerId == user.DNI);
        }
    }

    private async Task AddRol()
    {
        if (!string.IsNullOrEmpty(idSelected))
        {
            var identityUserRole = new IdentityUserRole<string>
                {
                    UserId = Id,
                    RoleId = idSelected
                };
            dbContext.UserRoles.Add(identityUserRole);
            await dbContext.SaveChangesAsync();
            await LoadUserRoles();
            StateHasChanged();
        }
    }

    private async Task RemoveRole(string roleId)
    {
        var userRole = userRoles.FirstOrDefault(ur => ur.RoleId == roleId && ur.UserId == Id);
        if (userRole != null)
        {
            dbContext.UserRoles.Remove(userRole);
            await dbContext.SaveChangesAsync();
            await LoadUserRoles();
            StateHasChanged();
        }
    }

    private async Task DisableSeller()
    {
        seller.IsActive = false;
        db.Seller.Update(seller);
        await db.SaveChangesAsync();
    }

    private async Task SuscribeSeller()
    {
        try
        {
            seller = db.Seller.FirstOrDefault(w => w.SellerId == user.DNI);
            if (seller == null)
            {
                seller = new Seller
                    {
                        SellerId = user.DNI,
                        SellerName = $"{user.Name} {user.LastName}",
                        Email = user.Email,
                        DNI = user.DNI,
                        IsActive = true
                    };
                using (var transaction = await db.Database.BeginTransactionAsync())
                {
                    db.Database.ExecuteSqlRaw("SET IDENTITY_INSERT [dbo].[Seller] ON");
                    db.Seller.Add(seller);
                    await db.SaveChangesAsync();
                    db.Database.ExecuteSqlRaw("SET IDENTITY_INSERT [dbo].[Seller] OFF");
                    await transaction.CommitAsync();
                }
            }
            else
            {
                seller.IsActive = true;
                db.Seller.Update(seller);
                await db.SaveChangesAsync();
            }
        }
        catch (Exception rtg)
        {
            
            throw;
        }
    }
}
