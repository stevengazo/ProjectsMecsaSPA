@using Microsoft.AspNetCore.Identity
@inject ApplicationDbContext dbContext
@inject SignInManager<UserIdentityEx> _signInManager
@inject UserManager<UserIdentityEx> userManager

<!-- ===================================== -->
<!-- DATOS DEL USUARIO -->
<!-- ===================================== -->
<EditForm Model="user">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <h5 class="fw-bold text-center mb-4">Datos del Usuario</h5>

    <div class="row g-3 p-2">
        <div class="col-md-6">
            <div class="form-floating">
                <InputText id="Name"
                           class="form-control shadow-sm"
                           @bind-Value="user.Name" />
                <label for="Name">Nombre</label>
            </div>
        </div>

        <div class="col-md-6">
            <div class="form-floating">
                <InputText id="LastName"
                           class="form-control shadow-sm"
                           @bind-Value="user.LastName" />
                <label for="LastName">Apellidos</label>
            </div>
        </div>

        <div class="col-md-6">
            <div class="form-floating">
                <InputNumber id="DNI"
                             class="form-control shadow-sm"
                             @bind-Value="user.DNI" />
                <label for="DNI">Cédula</label>
            </div>
        </div>

        <div class="col-md-6">
            <div class="form-floating">
                <InputText id="UserName"
                           class="form-control shadow-sm"
                           @bind-Value="user.UserName" />
                <label for="UserName">Nombre de Usuario</label>
            </div>
        </div>

        <div class="col-md-6">
            <div class="form-floating">
                <InputText id="Email"
                           type="email"
                           class="form-control shadow-sm"
                           @bind-Value="user.Email" />
                <label for="Email">Correo</label>
            </div>
        </div>

        <div class="col-md-6">
            <div class="form-floating">
                <InputText id="PhoneNumber"
                           class="form-control shadow-sm"
                           @bind-Value="user.PhoneNumber" />
                <label for="PhoneNumber">Teléfono</label>
            </div>
        </div>
    </div>
</EditForm>

<hr class="my-4" />

<!-- ===================================== -->
<!-- CREDENCIALES -->
<!-- ===================================== -->
<EditForm Model="PassObj">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <h5 class="fw-bold text-center mb-4">Credenciales</h5>

    <div class="row g-3 p-2">
        <div class="col-md-6">
            <div class="form-floating">
                <InputText id="Password"
                           type="password"
                           class="form-control shadow-sm"
                           @bind-Value="PassObj.Password" />
                <label for="Password">Contraseña</label>
            </div>
        </div>

        <div class="col-md-6">
            <div class="form-floating">
                <InputText id="ConfirmPass"
                           type="password"
                           class="form-control shadow-sm"
                           @bind-Value="PassObj.ConfirmPass" />
                <label for="ConfirmPass">Confirmar Contraseña</label>
            </div>
        </div>
    </div>
</EditForm>

<!-- ===================================== -->
<!-- ACCIONES -->
<!-- ===================================== -->
<div class="text-center mt-4">
    <button class="btn btn-outline-success px-5" @onclick="Add">
        Guardar Usuario
    </button>

    @if (!string.IsNullOrWhiteSpace(errorMessage))
    {
        <div class="text-danger mt-2">
            @errorMessage
        </div>
    }
</div>


@code {
    UserIdentityEx user = new();
    [Parameter]
    public EventCallback OnAdded { get; set; }

    private Pass PassObj = new();

    string errorMessage = "";

    private class Pass
    {
        public string Password { get; set; }
        public string ConfirmPass { get; set; }
    }


    private async Task Add()
    {try
        {
            user.EmailConfirmed = true;
            user.NormalizedEmail = user.Email.ToUpper();
            user.NormalizedUserName = user.UserName.ToUpper();
            if (PassObj.Password == PassObj.ConfirmPass)
            {
                var e = await userManager.CreateAsync(user, PassObj.Password);
                if (e.Succeeded)
                {
                    OnAdded.InvokeAsync();
                }

            }
        }
        catch (Exception e)
        {
            errorMessage = e.Message;
            throw;
        }

    }

}
