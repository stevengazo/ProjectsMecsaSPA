@using System.Security.Claims
@inject IDbContextFactory<ProjectsDBContext> DbContextFactory
@inject ApplicationDbContext dbIdentity;
@inject AuthenticationStateProvider asp;
@inject Bitrix24ClientService bitrix24Client;

<EditForm Model="commentary" class="d-flex flex-column gap-2 my-2">

    <InputTextArea @bind-Value="commentary.CommentaryText"
                   class="form-control"
                   placeholder="Escribe tu comentario..."
                   rows="3" />

    <button class="btn btn-sm btn-outline-success align-self-end px-4"
            @onclick="Add">
        Agregar
    </button>

</EditForm>

@code {
    [Parameter]
    public int ProjectId { get; set; }
    [Parameter]
    public EventCallback OnAdded { get; set; }

    ProjectsDBContext db;

    private Commentary commentary;

    protected override async Task OnInitializedAsync()
    {
        db = DbContextFactory.CreateDbContext();
        commentary = new();

        commentary.ProjectId = ProjectId;
        base.OnInitializedAsync();   
    }

    private async Task Add()
    {
        GetAuthor();

        commentary.CreationDate = DateTime.Now;
        commentary.ProjectId = ProjectId;
        db.Comments.Add(commentary);
        await db.SaveChangesAsync();
        GenerateComment();
        OnAdded.InvokeAsync();
        commentary = new();

    }

    private async Task GenerateComment(){
        var task = (from p in db.Projects
                    where p.ProjectId == ProjectId
                    select p.TaskNumber).FirstOrDefault();
        var taskValid = int.TryParse(task, out int taskNumber);
        if (taskValid)
        {    
            await bitrix24Client.SendTaskCommentAsync(taskNumber, commentary.CommentaryText,186);
        }
    }

    private async Task GetAuthor()
    {
        var s = asp.GetAuthenticationStateAsync();
        var user = s.Result.User;

        if (user.Identity.IsAuthenticated)
        {
            var u = user.FindFirst(ClaimTypes.Name)?.Value;
            var d = dbIdentity.Users.FirstOrDefault(e => e.UserName == u);
            commentary.Author = d.Name + "" + d.LastName;
          
            // Asigna el ID del autor basado en el usuario autenticado

        }
        else
        {
            commentary.Author = "Usuario no autenticado";
        }
    }

}
