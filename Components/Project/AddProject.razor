@page "/create-project"
@inject ProjectsDBContext db
@inject NavigationManager Nav;
@inject IDbContextFactory<ProjectsDBContext> DbContextFactory
@inject CentralBankService BancoCentralService
@inject FileStorageService FileStorageService
@inject Bitrix24ClientService Bitrix24Client


@using Microsoft.AspNetCore.Components.Forms
@using System.ComponentModel.DataAnnotations
@using System.Xml.Linq


<EditForm Model="@project" OnValidSubmit="@HandleValidSubmit">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <!-- ========================================================= -->
    <!-- INFORMACIÓN GENERAL DEL PROYECTO -->
    <!-- ========================================================= -->
    <h5 class="text-center fw-bold mb-4">Información General del Proyecto</h5>

    <div class="p-2">
        <div class="form-group mb-3">
            <div class="form-floating">
                <InputText id="Title" class="form-control shadow-sm" @bind-Value="project.Title" />
                <label for="Title">Título</label>
            </div>
            <ValidationMessage For="@(() => project.Title)" class="text-danger small" />
        </div>

        <div class="form-group mb-3">
            <div class="form-floating">
                <InputTextArea id="Description" class="form-control shadow-sm" @bind-Value="project.Description" />
                <label for="Description">Descripción</label>
            </div>
            <ValidationMessage For="@(() => project.Description)" class="text-danger small" />
        </div>

        <div class="row g-3">
            <div class="col-md-6">
                <div class="form-floating">
                    <InputText id="TaskNumber" class="form-control shadow-sm" @bind-Value="project.TaskNumber" />
                    <label for="TaskNumber">Número de Tarea</label>
                </div>
                <ValidationMessage For="@(() => project.TaskNumber)" class="text-danger small" />
            </div>

            <div class="col-md-6">
                <div class="form-floating">
                    <InputDate id="CreationDate" class="form-control shadow-sm" @bind-Value="project.CreationDate" />
                    <label for="CreationDate">Fecha de Registro</label>
                </div>
                <ValidationMessage For="@(() => project.CreationDate)" class="text-danger small" />
            </div>
        </div>
    </div>

    <hr class="my-4" />

    <!-- ========================================================= -->
    <!-- CLIENTE Y COMERCIAL -->
    <!-- ========================================================= -->
    <h5 class="text-center fw-bold mb-4">Cliente y Comercial</h5>

    <div class="p-2">
        <div class="form-group mb-3">
            <div class="form-floating">
                <InputSelect id="TypeId" class="form-control shadow-sm" @bind-Value="project.TypeId">
                    <option value="">Seleccione</option>
                    @foreach (var type in types)
                    {
                        <option value="@type.TypeId">@type.Name</option>
                    }
                </InputSelect>
                <label for="TypeId">Tipo de Proyecto</label>
            </div>
            <ValidationMessage For="@(() => project.TypeId)" class="text-danger small" />
        </div>

        <div class="form-group mb-4">
            <AutoComplete @bind-Value="customerName"
                          TItem="Customer"
                          class="form-control shadow-sm"
                          DataProvider="CustomersDataProvider"
                          PropertyName="Name"
                          Placeholder="Buscar Cliente..."
                          OnChanged="(Customer customer) => OnAutoCompleteChanged(customer)" />
            <ValidationMessage For="@(() => project.CustomerId)" class="text-danger small" />
        </div>

        <div class="form-group mb-3">
            <div class="form-floating">
                <InputTextArea id="Offer" class="form-control shadow-sm" @bind-Value="project.OfferId" />
                <label>Oferta</label>
            </div>
            <ValidationMessage For="@(() => project.OfferId)" class="text-danger small" />
        </div>
    </div>

    <hr class="my-4" />

    <!-- ========================================================= -->
    <!-- ESTADO Y CONFIGURACIÓN -->
    <!-- ========================================================= -->
    <h5 class="text-center fw-bold mb-4">Estado y Configuración</h5>

    <div class="p-2">
        <div class="form-group mb-3">
            <div class="form-floating">
                <InputSelect id="StateId" class="form-control shadow-sm" @bind-Value="project.StateId">
                    @foreach (var state in states)
                    {
                        <option value="@state.StateId">@state.StateName</option>
                    }
                </InputSelect>
                <label for="StateId">Estado</label>
            </div>
            <ValidationMessage For="@(() => project.StateId)" class="text-danger small" />
        </div>

        <div class="form-group mb-4">
            <div class="form-check form-switch d-flex align-items-center">
                <InputCheckbox id="RequiredCoordination"
                               class="form-check-input me-2 shadow-sm"
                               @bind-Value="project.RequiredCoordination" />
                <label class="form-check-label fw-semibold" for="RequiredCoordination">
                    Requiere Coordinación
                </label>
            </div>
        </div>
    </div>

    <hr class="my-4" />

    <!-- ========================================================= -->
    <!-- INFORMACIÓN FINANCIERA -->
    <!-- ========================================================= -->
    <h5 class="text-center fw-bold mb-4">Información Financiera</h5>

    <div class="p-2">
        <div class="row g-3">
            <div class="col-md-6">
                <div class="form-floating">
                    <InputNumber id="Amount" class="form-control shadow-sm" @bind-Value="project.Amount" />
                    <label>Monto (Sin IVA)</label>
                </div>
                <ValidationMessage For="@(() => project.Amount)" class="text-danger small" />
            </div>

            <div class="col-md-6">
                <div class="form-floating">
                    <InputNumber id="TypeOfChange" class="form-control shadow-sm" @bind-Value="project.TypeOfChange" />
                    <label>Tipo de Cambio</label>
                </div>
                <ValidationMessage For="@(() => project.TypeOfChange)" class="text-danger small" />
            </div>
        </div>

        <div class="row g-3 mt-1">
            <div class="col-md-6">
                <div class="form-floating">
                    <InputSelect class="form-select shadow-sm" @bind-Value="project.CurrencyType">
                        <option value=""></option>
                        <option value="en-US">Dólar</option>
                        <option value="es-CR">Colón</option>
                    </InputSelect>
                    <label>Moneda</label>
                </div>
                <ValidationMessage For="@(() => project.CurrencyType)" class="text-danger small" />
            </div>

            <div class="col-md-6">
                <div class="form-floating">
                    <InputNumber id="taxInput" class="form-control shadow-sm" max="13" min="0"
                                 @bind-Value="project.TAX" />
                    <label>Impuestos (%)</label>
                </div>
                <ValidationMessage For="@(() => project.TAX)" class="text-danger small" />
            </div>
        </div>
    </div>

    <hr class="my-4" />

    <!-- ========================================================= -->
    <!-- ORDEN DE COMPRA -->
    <!-- ========================================================= -->
    <h5 class="text-center fw-bold mb-4">Orden de Compra</h5>

    <div class="p-2">
        <div class="form-group mb-3">
            <div class="form-floating">
                <InputText id="OC" class="form-control shadow-sm" @bind-Value="project.OC" />
                <label for="OC">Orden de Compra</label>
            </div>
        </div>

        <div class="form-group mb-4">
            <div class="d-flex gap-2">
                <div class="form-floating flex-fill">
                    <InputDate id="OCDate" class="form-control shadow-sm" @bind-Value="project.OCDate" />
                    <label for="OCDate">Fecha Orden de Compra</label>
                </div>
                <Button Class="btn btn-outline-info btn-sm align-self-end"
                        @onclick="OnChangeOCDateAsync">
                    <Icon Name="IconName.CloudArrowDown" />
                    Tipo Cambio
                </Button>
            </div>
        </div>
    </div>

    <hr class="my-4" />

    <!-- ========================================================= -->
    <!-- UBICACIÓN -->
    <!-- ========================================================= -->
    <h5 class="text-center fw-bold mb-4">Ubicación</h5>

    <div class="p-2">
        <div class="form-group mb-3">
            <div class="form-floating">
                <InputText id="Ubication" class="form-control shadow-sm" @bind-Value="project.Ubication" />
                <label for="Ubication">Ubicación</label>
            </div>
        </div>

        <div class="form-group mb-4">
            <div class="form-floating">
                <InputSelect class="form-select shadow-sm" @bind-Value="project.Province">
                    <option value="">Seleccione</option>
                    <option value="San José">San José</option>
                    <option value="Heredia">Heredia</option>
                    <option value="Alajuela">Alajuela</option>
                    <option value="Cartago">Cartago</option>
                    <option value="Puntarenas">Puntarenas</option>
                    <option value="Guanacaste">Guanacaste</option>
                    <option value="Limón">Limón</option>
                </InputSelect>
                <label>Provincia</label>
            </div>
        </div>
    </div>

    <hr class="my-4" />

    <!-- ========================================================= -->
    <!-- DATOS INTERNOS -->
    <!-- ========================================================= -->
    <h5 class="text-center fw-bold mb-4">Datos Internos</h5>

    <div class="p-2">
        <div class="form-group mb-3">
            <div class="form-floating">
                <InputSelect class="form-control shadow-sm" @bind-Value="project.CompanyId">
                    <option value="">Seleccione</option>
                    @foreach (var i in Companies)
                    {
                        <option value="@i.CompanyId">@i.CompanyName</option>
                    }
                </InputSelect>
                <label>Compañía</label>
            </div>
            <ValidationMessage For="@(() => project.CompanyId)" class="text-danger small" />
        </div>

        <div class="form-group mb-4">
            <div class="form-floating">
                <InputSelect class="form-control shadow-sm" @bind-Value="project.SellerId">
                    @foreach (var seller in sellers)
                    {
                        <option value="@seller.SellerId">@seller.SellerName</option>
                    }
                </InputSelect>
                <label>Vendedor</label>
            </div>
            <ValidationMessage For="@(() => project.SellerId)" class="text-danger small" />
        </div>
    </div>

    <!-- ========================================================= -->
    <!-- SUBMIT -->
    <!-- ========================================================= -->
    <div class="form-group mt-4 text-center">
        <button type="submit" class="btn btn-outline-success btn-sm w-50">
            Crear Proyecto
        </button>

        <div class="text-danger mt-2">
            @ErrorMessage
        </div>
    </div>

</EditForm>



@code {
	[Parameter]
	public EventCallback OnAdded { get; set; }

	private Project project = new Project();
	private List<TypeModel> types = new List<TypeModel>();
	private List<Customer> customers = new List<Customer>();
	private List<Seller> sellers = new List<Seller>();
	private List<State> states = new List<State>();
	private List<Company> Companies = new List<Company>();

	private string ErrorMessage = "";

	private string? customerName;

	protected override async Task OnInitializedAsync()
	{
		project = new();

		project.TypeOfChange = await BancoCentralService.ObtenerTipoCambioAsync(DateTime.Now);
		// Cargar las dependencias desde la base de datos
		Companies = db.Company.ToList();
		types = db.Types.ToList();
		customers = db.Customers.ToList();
		sellers = db.Seller.Where(s => s.IsActive).OrderBy(s => s.SellerName).ToList();
		states = db.States.ToList();
		project.CreationDate = DateTime.Now;
		project.OCDate = DateTime.Now;
	}

	#region Central Bank Type Of change

	private async Task OnChangeOCDateAsync()
	{
		project.TypeOfChange = await BancoCentralService.ObtenerTipoCambioAsync(project.OCDate);
		StateHasChanged();
	}

	#endregion

	#region	Customer Autocomplete

	private async Task<AutoCompleteDataProviderResult<Customer>> CustomersDataProvider(AutoCompleteDataProviderRequest<Customer> request)
	{
		var customersf = db.Customers.Where(w => w.Name.Contains(request.Filter.Value));
		return await Task.FromResult(new AutoCompleteDataProviderResult<Customer> { Data = customersf, TotalCount = customersf.Count() });
	}

	private void OnAutoCompleteChanged(Customer customer)
	{
		if (customer != null)
		{
			customerName = customer.Name;
			project.Customer = customer;
			project.CustomerId = customer.CustomerId;
		}
	}

	#endregion

	private void ClearFormFields()
	{
		project = new Project
			{
				CreationDate = DateTime.Now,
				OCDate = DateTime.Now
			};

		customerName = string.Empty;

		// Resetear cualquier campo adicional si es necesario
	}

	private async Task SendBitrixCommentary()
	{
		var valid = int.TryParse(project.TaskNumber, out int taskNumber);
		await  Bitrix24Client.SendTaskCommentAsync(taskNumber, $"Número de Proyecto {project.ProjectId}. Ver más detalles en app para proyectos.", 252);
		var result = await  Bitrix24Client.CreateSubfolderAsync(1116310, project.ProjectId.ToString() + "--" + project.Title);
		project.FolderIDB24 = result;

		db.Projects.Update(project);	
		await db.SaveChangesAsync();	
	}

	private void ResetProjectsIdentity()
	{
		try
		{
			var dbtmp = DbContextFactory.CreateDbContext();
			var lastProject = dbtmp.Projects.OrderByDescending(p => p.ProjectId).FirstOrDefault();
			if (lastProject != null)
			{
				using (var connection = dbtmp.Database.GetDbConnection())
				{
					connection.Open();
					using (var command = connection.CreateCommand())
					{
						command.CommandText = $"DBCC CHECKIDENT ('dbo.Projects', RESEED, {lastProject.ProjectId});";
						command.ExecuteNonQuery();
					}
					connection.Close();
				}
				Console.WriteLine("El contador de identidad se ha reseteado correctamente.");
			}
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Error al resetear el contador de identidad: {ex.Message}");
		}
	}

	private async Task HandleValidSubmit()
	{
		ResetProjectsIdentity();

		if (project != null)
		{
			using (var transaction = await db.Database.BeginTransactionAsync())
			{
				try
				{

					project.IsCompleted = false;
					project.Isfactured = false;
					db.Projects.Add(project);
					await db.SaveChangesAsync();
					transaction.Commit();
					await FileStorageService.GenerateProjectDirectoryAsync(project.ProjectId);
					SendBitrixCommentary();// Mensaje automatico a bitrix
					Nav.NavigateTo($"projects/{project.ProjectId}");
				}
				catch (Exception e)
				{
					transaction.Rollback();
					ErrorMessage = "Error, Verifique los datos";
				}
			}
		}
	}
}

