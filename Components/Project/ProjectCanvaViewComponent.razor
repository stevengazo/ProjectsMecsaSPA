@inject ProjectsDBContext db



<!-- ===================== -->
<!-- INFORMACIÓN PROYECTO -->
<!-- ===================== -->
<div class="card mb-3 shadow-sm border-light rounded-3">
    <div class="card-header bg-white border-0 text-center fw-bold">
        Información del Proyecto
    </div>

    <div class="card-body p-3">
        <table class="table small table-borderless mb-0">
            <tbody>
                <tr>
                    <th class="text-sm text-muted">ID</th>
                    <td>@project.ProjectId</td>
                </tr>
                <tr>
                    <th class="text-muted">Título</th>
                    <td>@project.Title</td>
                </tr>
                <tr>
                    <th class="text-muted">Cliente</th>
                    <td>@project.Customer?.Name</td>
                </tr>
                <tr>
                    <th class="text-muted">Vendedor</th>
                    <td>@project.Seller?.SellerName</td>
                </tr>
                <tr>
                    <th class="text-muted">Etapa</th>
                    <td>@project.State?.StateName</td>
                </tr>
                <tr>
                    <th class="text-muted">Tipo de Proyecto</th>
                    <td>@project.Type?.Name</td>
                </tr>
                <tr>
                    <th class="text-muted">Tarea</th>
                    <td>@project.TaskNumber</td>
                </tr>
                <tr>
                    <th class="text-muted">Fecha de Creación</th>
                    <td>@project.CreationDate.ToLongDateString()</td>
                </tr>
                <tr>
                    <th class="text-muted">Orden de Compra</th>
                    <td>@project.OC</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<hr />
<!-- ========== -->
<!-- ACCIONES -->
<!-- ========== -->
<div class="card mb-3 shadow-sm border-light rounded-3">
    <div class="card-header bg-white border-0 fw-bold">
        Acciones
    </div>

    <div class="card-body d-flex gap-2">
        <a class="btn btn-outline-secondary btn-sm" href="/projects/@project.ProjectId">
            Ver Proyecto
        </a>
        <a class="btn btn-outline-secondary btn-sm" target="_blank"
           href="https://grupomecsa.bitrix24.es/company/personal/user/107/tasks/task/view/@project.TaskNumber/">
            Ver Tarea
        </a>
    </div>
</div>


<!-- ===================== -->
<!-- TABS (AUTORIZADOS) -->
<!-- ===================== -->
<AuthorizeView Roles="administrador,ingeniero,asistente">
    <Authorized>

        <Tabs>

            <!-- AGREGAR COMENTARIO -->
            <Tab Title="Comentarios" Icon="CommentDots">
                <Content>
                    <div class="mb-3">
                        <strong>Nuevo Comentario</strong>
                        <div class="card-body">
                            <CommentaryAddComponent ProjectId="project.ProjectId"
                                                    OnAdded="UpdateCommentaries" />
                        </div>
                    </div>

                    <!-- ===================== -->
                    <!-- COMENTARIOS EXISTENTES -->
                    <!-- ===================== -->
                    @if (project.Commentaries.Any())
                    {
                        <div class=" mb-3  ">
                            <div class="card-header bg-white border-0 fw-bold">
                                Comentarios
                            </div>

                            <div class="card-body d-flex flex-column gap-2">
                                @foreach (var c in project.Commentaries)
                                {
                                    <div class="border rounded-2 p-3 bg-light">
                                        <div class="d-flex justify-content-between">
                                            <strong>@c.Author</strong>
                                            <small class="text-muted">@c.CreationDate.ToString("dd MMM yy")</small>
                                        </div>

                                        <hr class="my-2" />

                                        <p class="mb-0 text-muted text-italic" style="white-space: pre-line;">
                                            @c.CommentaryText
                                        </p>
                                    </div>
                                }
                            </div>
                        </div>
                    }





                </Content>
            </Tab>

            <!-- CRONOGRAMA -->
            <Tab Title="Cronograma">
                <Content>
                    <div class="card shadow-sm mb-3">
                        <div class="card-header">
                            <strong>Cronograma del Proyecto</strong>
                        </div>
                        <div class="card-body">
                            <AddSchedule ProjectId="project.ProjectId" />
                            <ProjectScheduleViewComponent ProjectId="project.ProjectId" />
                        </div>
                    </div>
                </Content>
            </Tab>

        </Tabs>

    </Authorized>
</AuthorizeView>


@code {
    [Parameter]
    public Project project { get; set; }

    public async Task UpdateCommentaries()
    {
        project.Commentaries = db.Comments.Where(i => i.ProjectId == project.ProjectId).OrderByDescending(e => e.CommentaryID).ToList();

    }

}
