@inject IJSRuntime JSRuntime
@inject ProjectsDBContext db

@using Microsoft.EntityFrameworkCore
@using System.Linq

<h3>Projects</h3>

<!-- Contenedor para la tabla de proyectos con evento de scroll -->
<div @ref="scrollContainer" @onscroll="OnScroll" style="height: 500px; overflow-y: auto;">
    @if (projects != null && projects.Any())
    {
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Description</th>
                    <th>Creation Date</th>
                    <th>Amount</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var project in projects)
                {
                    <RowTableComponent ProjectObj="project" />
                }
            </tbody>
        </table>

        @if (isLoading)
        {
            <div>Loading...</div>
        }
    }
    else
    {
        <p>No projects found.</p>
    }
</div>

@code {
    private List<Project> projects = new List<Project>();  // Lista para almacenar proyectos
    private int currentPage = 1;      // Página actual
    private bool isLoading = false;   // Indicador de carga

    private ElementReference scrollContainer;

    // Cargar los proyectos iniciales
    protected override async Task OnInitializedAsync()
    {
        await LoadProjectsAsync();
    }

    // Maneja el evento de scroll
    private async Task OnScroll()
    {
        var scrollPosition = await JSRuntime.InvokeAsync<double>("getScrollPosition", scrollContainer);
        var clientHeight = await JSRuntime.InvokeAsync<double>("getClientHeight", scrollContainer);
        var scrollHeight = await JSRuntime.InvokeAsync<double>("getScrollHeight", scrollContainer);

        if (scrollPosition + clientHeight >= scrollHeight - 100 && !isLoading)
        {
            currentPage++;
            await LoadProjectsAsync();
        }
    }

    // Carga los proyectos de la página especificada
    private async Task LoadProjectsAsync()
    {
        isLoading = true;
        int pageSize = 50;

        var newProjects = await db.Projects
                                   .Include(i => i.State)
                                   .Include(i => i.Customer)
                                   .Where(p => !p.IsDeleted)
                                   .OrderBy(p => p.CreationDate) // Ordena los proyectos por fecha de creación
                                   .Skip((currentPage - 1) * pageSize)
                                   .Take(pageSize)
                                   .ToListAsync();

        if (newProjects.Any())
        {
            projects.AddRange(newProjects);
        }

        isLoading = false;

        // Forzar una actualización de la interfaz para asegurarse de que el contenedor de desplazamiento se actualice
        StateHasChanged();
    }
}
