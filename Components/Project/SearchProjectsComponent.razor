@using ProjectsMecsaSPA.Utilities
@inject IDbContextFactory<ProjectsDBContext> DbContextFactory
@inject IJSRuntime JS

<Toasts class="p-3" Messages="messages" Placement="ToastsPlacement.TopRight" />
<div class="border rounded shadow-sm p-3 mb-3">

    <h6 class="fw-bold mb-3">Filtros de Búsqueda</h6>

    <div class="row g-2 align-items-end">

        <!-- Nombre -->
        <div class="col-md-2">
            <label class="form-label small fw-semibold">Nombre</label>
            <input type="text"
                   @bind="searchName"
                   placeholder="Buscar por nombre"
                   class="form-control form-control-sm" />
        </div>

        <!-- Proyecto -->
        <div class="col-md-2">
            <label class="form-label small fw-semibold">Proyecto</label>
            <input type="number"
                   min="0"
                   @bind="searchProjectId"
                   placeholder="N° Proyecto"
                   class="form-control form-control-sm" />
        </div>

        <!-- Fecha -->
        @if (ValidInputs.EnableDate)
        {
            <div class="col-md-3">
                <label class="form-label small fw-semibold">Rango de fechas</label>
                <div class="d-flex gap-2 align-items-center">
                    <input type="date"
                           @bind="searchDateStart"
                           class="form-control form-control-sm" />

                    <input type="date"
                           @bind="searchDateEnd"
                           class="form-control form-control-sm" />

                    <button class="btn btn-sm btn-outline-danger"
                            @onclick="() => ValidInputs.EnableDate = false">
                        <Icon Name="IconName.X" />
                    </button>
                </div>
            </div>
        }

        <!-- Estado -->
        @if (ValidInputs.EnableState)
        {
            <div class="col-md-2">
                <label class="form-label small fw-semibold">Estado</label>
                <div class="d-flex gap-2 align-items-center">
                    <select @bind="searchStateId"
                            class="form-select form-select-sm">
                        <option value="">Seleccionar estado</option>
                        @foreach (var state in StatesOfProjects)
                        {
                            <option value="@state.Key">@state.Value</option>
                        }
                    </select>

                    <button class="btn btn-sm btn-outline-danger"
                            @onclick="() => ValidInputs.EnableState = false">
                        <Icon Name="IconName.X" />
                    </button>
                </div>
            </div>
        }

        <!-- Tipo -->
        @if (ValidInputs.EnableType)
        {
            <div class="col-md-2">
                <label class="form-label small fw-semibold">Tipo</label>
                <div class="d-flex gap-2 align-items-center">
                    <select @bind="searchTypeId"
                            class="form-select form-select-sm">
                        <option value="">Seleccionar tipo</option>
                        @foreach (var type in TypesOfProjects)
                        {
                            <option value="@type.Key">@type.Value</option>
                        }
                    </select>

                    <button class="btn btn-sm btn-outline-danger"
                            @onclick="() => ValidInputs.EnableType = false">
                        <Icon Name="IconName.X" />
                    </button>
                </div>
            </div>
        }

        <!-- Vendedor -->
        @if (ValidInputs.EnableSeller)
        {
            <div class="col-md-2">
                <label class="form-label small fw-semibold">Vendedor</label>
                <div class="d-flex gap-2 align-items-center">
                    <select @bind="searchSellerId"
                            class="form-select form-select-sm">
                        <option value="">Seleccionar vendedor</option>
                        @foreach (var seller in Sellers)
                        {
                            <option value="@seller.Key">@seller.Value</option>
                        }
                    </select>

                    <button class="btn btn-sm btn-outline-danger"
                            @onclick="() => ValidInputs.EnableSeller = false">
                        <Icon Name="IconName.X" />
                    </button>
                </div>
            </div>
        }

        <!-- Empresa -->
        @if (ValidInputs.EnableCompany)
        {
            <div class="col-md-2">
                <label class="form-label small fw-semibold">Empresa</label>
                <div class="d-flex gap-2 align-items-center">
                    <select @bind="searchCompanyId"
                            class="form-select form-select-sm">
                        <option value="">Seleccionar empresa</option>
                        @foreach (var company in Companies)
                        {
                            <option value="@company.CompanyId">@company.CompanyName</option>
                        }
                    </select>

                    <button class="btn btn-sm btn-outline-danger"
                            @onclick="() => ValidInputs.EnableCompany = false">
                        <Icon Name="IconName.X" />
                    </button>
                </div>
            </div>
        }

        <!-- Tarea -->
        @if (ValidInputs.EnableTask)
        {
            <div class="col-md-2">
                <label class="form-label small fw-semibold">N° Tarea</label>
                <div class="d-flex gap-2 align-items-center">
                    <input type="number"
                           min="0"
                           @bind="searchTask"
                           class="form-control form-control-sm" />

                    <button class="btn btn-sm btn-outline-danger"
                            @onclick="() => ValidInputs.EnableTask = false">
                        <Icon Name="IconName.X" />
                    </button>
                </div>
            </div>
        }

        <!-- BOTONES PARA ACTIVAR FILTROS -->
        <div class="col-md-12 mt-2">
            <div class="d-flex flex-wrap gap-2">

                @if (!ValidInputs.EnableState)
                {
                    <Tooltip Title="Estado">
                        <button class="btn btn-sm btn-outline-success"
                                @onclick="() => ValidInputs.EnableState = true">
                            <Icon Name="IconName.Check" />
                        </button>
                    </Tooltip>
                }

                @if (!ValidInputs.EnableDate)
                {
                    <Tooltip Title="Fecha">
                        <button class="btn btn-sm btn-outline-success"
                                @onclick="() => ValidInputs.EnableDate = true">
                            <Icon Name="IconName.Calendar2Date" />
                        </button>
                    </Tooltip>
                }

                @if (!ValidInputs.EnableType)
                {
                    <Tooltip Title="Tipo">
                        <button class="btn btn-sm btn-outline-success"
                                @onclick="() => ValidInputs.EnableType = true">
                            <Icon Name="IconName.Type" />
                        </button>
                    </Tooltip>
                }

                @if (!ValidInputs.EnableSeller)
                {
                    <Tooltip Title="Vendedor">
                        <button class="btn btn-sm btn-outline-success"
                                @onclick="() => ValidInputs.EnableSeller = true">
                            <Icon Name="IconName.People" />
                        </button>
                    </Tooltip>
                }

                @if (!ValidInputs.EnableCompany)
                {
                    <Tooltip Title="Empresa">
                        <button class="btn btn-sm btn-outline-success"
                                @onclick="() => ValidInputs.EnableCompany = true">
                            <Icon Name="IconName.Building" />
                        </button>
                    </Tooltip>
                }

                @if (!ValidInputs.EnableTask)
                {
                    <Tooltip Title="Tarea">
                        <button class="btn btn-sm btn-outline-success"
                                @onclick="() => ValidInputs.EnableTask = true">
                            <Icon Name="IconName.SortNumericUp" />
                        </button>
                    </Tooltip>
                }

            </div>
        </div>
    </div>
</div>

<!-- ACCIONES -->
<div class="row g-2 align-items-end mb-3">
    <div class="col-md-2 col-sm-4">
        <button @onclick="ApplyFiltersAsync"
                class="btn btn-outline-primary btn-sm w-100 d-flex align-items-center justify-content-center gap-1">
            <Icon Name="IconName.Search" />
            <span>Buscar</span>
        </button>
    </div>

    <div class="col-md-2 col-sm-4">
        <button @onclick="DownloadReportAsync"
                class="btn btn-outline-warning btn-sm w-100 d-flex align-items-center justify-content-center gap-1">
            <Icon Name="IconName.Download" />
            <span>Descargar</span>
        </button>
    </div>

    <div class="col-md-2 col-sm-4">
        <button @onclick="ClearFilters"
                class="btn btn-outline-secondary btn-sm w-100 d-flex align-items-center justify-content-center gap-1">
            <Icon Name="IconName.Circle" />
            <span>Limpiar</span>
        </button>
    </div>
</div>


<!-- Contenedor para la tabla de proyectos -->
<div>
    @if (Searching)
    {
        <div class="d-flex justify-content-center">
            <Spinner Type="SpinnerType.Border" />
        </div>
    }
    else
    {
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>N</th>
                    <th>Titulo</th>
                    <th>Cliente</th>
                    <th>Vendedor</th>
                    <th>Estado</th>
                    <th>OC</th>
                    <th>Compañia</th>
                    <th>Tipo</th>
                    <th>Creación</th>
                    <th>Monto</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var project in projects)
                {
                    <RowTableComponent ProjectObj="project" />
                }
            </tbody>
        </table>
    }
</div>

@code {
    private bool Searching = false;
    private List<Project> projects = new();
    private string searchName = string.Empty;
    private int searchProjectId;
    private DateTime searchDateStart = DateTime.Today;
    private DateTime searchDateEnd = DateTime.Today;
    private int? searchStateId;
    private int? searchTypeId;
    private int? searchSellerId;
    private int? searchCompanyId;
    private int? searchTask;

    private Dictionary<int, string> TypesOfProjects = new();
    private Dictionary<int, string> StatesOfProjects = new();
    private List<Company> Companies = new();

    private SearchInputs ValidInputs = new();
    private string? message;
    List<ToastMessage> messages = new List<ToastMessage>();

    Dictionary<int, string> Sellers = new();

    private async Task LoadSellers()
    {
        using (var d = DbContextFactory.CreateDbContext())
        {
            Sellers = d.Seller
            .AsNoTracking()
            .Where(e => e.IsActive)
            .OrderBy(d => d.SellerName)
            .ToDictionary(d => d.SellerId, d => d.SellerName);
        }
    }

    // Cargar los proyectos iniciales
    protected override async Task OnInitializedAsync()
    {
        LoadSellers();
        using (var d = DbContextFactory.CreateDbContext())
        {
            Companies = d.Company.AsNoTracking().ToList();
            TypesOfProjects = d.Types
                .AsNoTracking()
                .ToDictionary(e => e.TypeId, e => e.Name);
            StatesOfProjects = d.States
                .AsNoTracking()
                .ToDictionary(e => e.StateId, e => e.StateName);
        }
        //  await LoadProjectsAsync();
    }

    // Aplica los filtros y recarga los proyectos
    private async Task ApplyFiltersAsync()
    {
        await LoadProjectsAsync();
    }

    // Limpia los filtros de búsqueda y recarga la lista de proyectos
    private async Task ClearFilters()
    {
        searchName = string.Empty;
        searchProjectId = 0;
        searchDateStart = DateTime.Today;
        searchDateEnd = DateTime.Today;
        searchStateId = null;
        searchTypeId = null;
        searchSellerId = null;

        ValidInputs.EnableDate = false;
        ValidInputs.EnableState = false;
        ValidInputs.EnableType = false;
        ValidInputs.EnableSeller = false;
        ValidInputs.EnableCompany = false;
        ValidInputs.EnableTask = false;

        projects.Clear();
        StateHasChanged();
    }

    // Carga los proyectos según los filtros aplicados
    private async Task LoadProjectsAsync()
    {
        Searching = true;
        bool canSearch = false;
        using (var db = await DbContextFactory.CreateDbContextAsync())
        {
            var query = db.Projects.AsQueryable();

            if (!string.IsNullOrWhiteSpace(searchName))
            {
                query = query.Where(p => p.Title.Contains(searchName));
                canSearch = true;
            }

            if (searchProjectId > 0)
            {
                query = query.Where(p => p.ProjectId == searchProjectId);
                canSearch = true;
            }

            if (searchDateStart != default && ValidInputs.EnableDate)
            {
                query = query.Where(p => p.CreationDate >= searchDateStart && p.CreationDate < searchDateEnd);
                canSearch = true;
            }

            if (searchStateId.HasValue && ValidInputs.EnableState)
            {
                query = query.Where(p => p.StateId == searchStateId);
                canSearch = true;
            }

            if (searchTypeId.HasValue && ValidInputs.EnableType)
            {
                query = query.Where(p => p.TypeId == searchTypeId);
                canSearch = true;
            }

            if (searchSellerId.HasValue && ValidInputs.EnableSeller)
            {
                query = query.Where(p => p.SellerId == searchSellerId);
                canSearch = true;
            }

            if (searchCompanyId.HasValue && ValidInputs.EnableCompany)
            {
                query = query.Where(p => p.CompanyId == searchCompanyId);
                canSearch = true;
            }
            if (searchTask.HasValue && ValidInputs.EnableTask)
            {
                query = query.Where(p => p.TaskNumber == searchTask.ToString());
                canSearch = true;
            }

            if (canSearch)
            {
                projects = await query
                    .AsNoTracking()
                    .Include(p => p.State)
                    .Include(p => p.Customer)
                    .Include(p => p.Type)
                       .Include(p => p.Company)
                    .OrderByDescending(p => p.ProjectId)
                    .ToListAsync();

                if (projects.Count == 0)
                {
                    messages.Add(new()
                    {
                        Message = "No hay resultados",
                        Type = ToastType.Danger
                    });
                }
            }
            else
            {
                messages.Add(new()
                {
                    Message = "No puede realizar la búsqueda. Aplique un filtro",
                    Type = ToastType.Warning
                });
            }
        }
        Searching = false;
        await InvokeAsync(StateHasChanged);
    }

    // Genera y descarga el reporte
    private async Task DownloadReportAsync()
    {
        messages.Add(new()
        {
            Message = "Generando Documento",
            Type = ToastType.Info
        });
        var data = await XmlsGenerate.GenerateFileProjects(projects);
        var pdfBase64 = Convert.ToBase64String(data);

        // Invocar una función JavaScript para iniciar la descarga del PDF
        await JS.InvokeVoidAsync("downloadPDF", pdfBase64, $"Proyectos_{DateTime.Now:yyyyMMdd_HHmm}.xlsx");
    }


    private class SearchInputs
    {
        public bool EnableTitle { get; set; }
        public bool EnableProjectId { get; set; }
        public bool EnableDate { get; set; }
        public bool EnableState { get; set; }
        public bool EnableType { get; set; }
        public bool EnableSeller { get; set; }
        public bool EnableCompany { get; set; }
        public bool EnableTask { get; set; }
    }
}
