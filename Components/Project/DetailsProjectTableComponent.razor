@page "/project-edit"
@inject ProjectsDBContext db

@using System.ComponentModel.DataAnnotations

@if (IsEditing)
{
    <EditForm Model="project" OnValidSubmit="Update">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <table class="table table-hover border">
            <tbody>
                <tr>
                    <th>@nameof(project.ProjectId)</th>
                    <td>@project.ProjectId</td>
                </tr>
                <tr>
                    <th>@nameof(project.Title)</th>
                    <td>
                        <InputText @bind-Value="project.Title" class="form-control form-control-sm" />
                        <ValidationMessage For="@(() => project.Title)" />
                    </td>
                </tr>
                <tr>
                    <th>@nameof(project.Description)</th>
                    <td>
                        <InputText @bind-Value="project.Description" class="form-control form-control-sm" />
                        <ValidationMessage For="@(() => project.Description)" />
                    </td>
                </tr>
                <tr>
                    <th>@nameof(project.TaskNumber)</th>
                    <td>
                        <InputText @bind-Value="project.TaskNumber" class="form-control form-control-sm" />
                        <ValidationMessage For="@(() => project.TaskNumber)" />
                    </td>
                </tr>
                <tr>
                    <th>@nameof(project.Customer)</th>
                    <td>

                 
                        <AutoComplete @bind-Value="customerName"
                                      TItem="Customer"
                                      class="text-danger"
                                      DataProvider="CustomersDataProvider"
                                      PropertyName="Name"
                                      Placeholder="Search a customer..."
                                      OnChanged="(Customer customer) => OnAutoCompleteChanged(customer)" />
                                     
                    </td>
                </tr>
                <tr>
                    <th>@nameof(project.Ubication)</th>
                    <td>
                        <InputText @bind-Value="project.Ubication" class="form-control form-control-sm" />
                        <ValidationMessage For="@(() => project.Ubication)" />
                    </td>
                </tr>
                <tr>
                    <th>@nameof(project.Amount)</th>
                    <td>
                        <InputNumber @bind-Value="project.Amount" class="form-control form-control-sm" />
                        <ValidationMessage For="@(() => project.Amount)" />
                    </td>
                </tr>
                <tr>
                    <th>@nameof(project.CreationDate)</th>
                    <td>
                        <InputDate @bind-Value="project.CreationDate" class="form-control form-control-sm" />
                        <ValidationMessage For="@(() => project.CreationDate)" />
                    </td>
                </tr>
                <tr>
                    <th>@nameof(project.State)</th>
                    <td>
                        <InputSelect @bind-Value="project.StateId" class="form-control form-control-sm">
                            <option value="">Seleccionar estado</option>
                            @foreach (var item in States)
                            {
                                <option value="@item.Key">@item.Value</option>
                            }
                        </InputSelect>
                        <ValidationMessage For="@(() => project.StateId)" />
                    </td>
                </tr>
                <tr>
                    <th>@nameof(project.Type)</th>
                    <td>@project.Type.Name</td>
                </tr>
                <tr>
                    <th>@nameof(project.OC)</th>
                    <td>
                        <InputText @bind-Value="project.OC" class="form-control form-control-sm" />
                        <ValidationMessage For="@(() => project.OC)" />
                    </td>
                </tr>
                <tr>
                    <th>@nameof(project.OCDate)</th>
                    <td>
                        <InputDate @bind-Value="project.OCDate" class="form-control form-control-sm" />
                        <ValidationMessage For="@(() => project.OCDate)" />
                    </td>
                </tr>
            </tbody>
        </table>

        <button type="button" class="btn btn-sm btn-outline-danger" @onclick="CancelEdit">Cancelar</button>
        <button type="submit" class="btn btn-sm btn-outline-info">Actualizar</button>
    </EditForm>
}
else
{
    <table class="table table-hover border">
        <tbody>
            <tr>
                <th>@nameof(project.ProjectId)</th>
                <td>@project.ProjectId</td>
            </tr>
            <tr>
                <th>@nameof(project.Title)</th>
                <td>@project.Title</td>
            </tr>
            <tr>
                <th>@nameof(project.Description)</th>
                <td>@project.Description</td>
            </tr>
            <tr>
                <th>@nameof(project.TaskNumber)</th>
                <td>@project.TaskNumber</td>
            </tr>
            <tr>
                <th>@nameof(project.Customer)</th>
                <td>@project.Customer?.Name </td>
            </tr>
            <tr>
                <th>@nameof(project.Ubication)</th>
                <td>@project.Ubication</td>
            </tr>
            <tr>
                <th>@nameof(project.Amount)</th>
                <td>@project.Amount</td>
            </tr>
            <tr>
                <th>@nameof(project.CreationDate)</th>
                <td>@project.CreationDate.ToLongDateString()</td>
            </tr>
            <tr>
                <th>@nameof(project.State)</th>
                <td>@project.State?.StateName</td>
            </tr>
            <tr>
                <th>@nameof(project.Type)</th>
                <td>@project.Type?.Name</td>
            </tr>
            <tr>
                <th>@nameof(project.OC)</th>
                <td>@project.OC</td>
            </tr>
            <tr>
                <th>@nameof(project.OCDate)</th>
                <td>@project.OCDate.ToLongDateString()</td>
            </tr>
        </tbody>
    </table>
    <button class="btn btn-sm btn-outline-info" @onclick="StartEdit">Editar Proyecto</button>
}

@code {
    [Parameter]
    public Project project { get; set; }
    private bool IsEditing = false;

    private string? customerName;

    private Dictionary<int, string> customers = new();
    private Dictionary<int, string> filteredCustomers = new();
    private Dictionary<int, string> States = new();

    private string searchCustomer = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        customers = await db.Customers.ToDictionaryAsync(e => e.CustomerId, r => r.Name);
        filteredCustomers = customers; // Inicialmente, todos los clientes están disponibles
        States = await db.States
            .Where(i => !i.IsDeleted)
            .OrderByDescending(e => e.StateName)
            .ToDictionaryAsync(e => e.StateId, r => r.StateName);
    }

    private async Task<AutoCompleteDataProviderResult<Customer>> CustomersDataProvider(AutoCompleteDataProviderRequest<Customer> request)
    {
        var customersf = db.Customers.Where(w => w.Name.Contains(request.Filter.Value));
        return await Task.FromResult(new AutoCompleteDataProviderResult<Customer> { Data = customersf, TotalCount = customersf.Count() });
    }

    private void OnAutoCompleteChanged(Customer customer)
    {
        if(customer != null)
        {
            customerName = customer.Name;
            project.Customer = customer;
            project.CustomerId = customer.CustomerId;
        }
    }

 

    private void StartEdit()
    {
        IsEditing = true;
    }

    private void CancelEdit()
    {
        IsEditing = false;
    }

    private async Task Update()
    {
        try
        {
            if (project != null)
            {
                // Desvincula relaciones si es necesario
                project.Seller = db.Seller.FirstOrDefault(e => e.SellerId == project.SellerId);
                project.State = db.States.FirstOrDefault(e => e.StateId == project.StateId);
                project.Customer = db.Customers.FirstOrDefault(e => e.CustomerId == project.CustomerId);
                project.Type = db.Types.FirstOrDefault(e => e.TypeId == project.TypeId);
                db.Projects.Update(project);
                await db.SaveChangesAsync();

                // Recargar el objeto desde la base de datos
                project = await db.Projects
                    .Include(p => p.Customer)
                    .Include(p => p.State)
                    .Include(p => p.Type)
                    .FirstOrDefaultAsync(p => p.ProjectId == project.ProjectId);

                IsEditing = false;
            }
        }
        catch (Exception ex)
        {
            // Manejar el error de actualización aquí
            Console.WriteLine($"Error al actualizar el proyecto: {ex.Message}");
        }
    }
}
