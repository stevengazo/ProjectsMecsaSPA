@page "/project-edit"
@inject ProjectsDBContext db
@inject IJSRuntime JS
@inject IDbContextFactory<ProjectsDBContext> DbContextFactory


@using System.ComponentModel.DataAnnotations
@using System.Globalization
@using ProjectsMecsaSPA.Utilities


@if (IsEditing)
{
    <EditForm Model="project" OnValidSubmit="Update">
        <DataAnnotationsValidator />
        <ValidationSummary class="mb-3" />

        <div class="card border-0 shadow-sm">
            <div class="card-body p-4">

                <!-- INFORMACIÓN BÁSICA -->
                <div class="mb-4">
                    <h6 class="text-muted small fw-semibold mb-3">INFORMACIÓN DEL PROYECTO</h6>

                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label small text-muted">Número</label>
                            <div class="fw-semibold">@project.ProjectId</div>
                        </div>

                        <div class="col-md-9">
                            <label class="form-label small">Título</label>
                            <InputText @bind-Value="project.Title" class="form-control form-control-sm" />
                            <ValidationMessage For="@(() => project.Title)" />
                        </div>

                        <div class="col-12">
                            <label class="form-label small">Descripción</label>
                            <InputText @bind-Value="project.Description" class="form-control form-control-sm" />
                            <ValidationMessage For="@(() => project.Description)" />
                        </div>
                    </div>
                </div>
                <hr/>
                <!-- RELACIONES -->
                <div class="mb-4">
                    <h6 class="text-muted small fw-semibold mb-3">RELACIONES</h6>

                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label small">Tarea</label>
                            <InputText @bind-Value="project.TaskNumber" class="form-control form-control-sm" />
                            <ValidationMessage For="@(() => project.TaskNumber)" />
                        </div>

                        <div class="col-md-4">
                            <label class="form-label small">Cliente</label>
                            <AutoComplete @bind-Value="customerName"
                                          TItem="Customer"
                                          DataProvider="CustomersDataProvider"
                                          PropertyName="Name"
                                          Placeholder="Buscar cliente..."
                                          OnChanged="(Customer c) => OnAutoCompleteChanged(c)" />
                        </div>

                        <div class="col-md-4">
                            <label class="form-label small">Compañía</label>
                            <InputSelect @bind-Value="project.CompanyId" class="form-select form-select-sm">
                                @foreach (var item in companies)
                                {
                                    <option value="@item.CompanyId">@item.CompanyName</option>
                                }
                            </InputSelect>
                        </div>
                    </div>
                </div>
                <hr />
                <!-- UBICACIÓN -->
                <div class="mb-4">
                    <h6 class="text-muted small fw-semibold mb-3">UBICACIÓN</h6>

                    <div class="row g-3">
                        <div class="col-md-8">
                            <label class="form-label small">Ubicación</label>
                            <InputText @bind-Value="project.Ubication" class="form-control form-control-sm" />
                            <ValidationMessage For="@(() => project.Ubication)" />
                        </div>

                        <div class="col-md-4">
                            <label class="form-label small">Provincia</label>
                            <InputSelect class="form-select form-select-sm" @bind-Value="project.Province">
                                <option value="">Seleccionar</option>
                                <option>San José</option>
                                <option>Heredia</option>
                                <option>Alajuela</option>
                                <option>Cartago</option>
                                <option>Puntarenas</option>
                                <option>Guanacaste</option>
                                <option>Limón</option>
                            </InputSelect>
                            <ValidationMessage For="@(() => project.Province)" />
                        </div>
                    </div>
                </div>
                <hr />

                <!-- DATOS COMERCIALES -->
                <div class="mb-4">
                    <h6 class="text-muted small fw-semibold mb-3">DATOS COMERCIALES</h6>

                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label small">Monto</label>
                            <InputNumber @bind-Value="project.Amount" class="form-control form-control-sm" />
                            <ValidationMessage For="@(() => project.Amount)" />
                        </div>

                        <div class="col-md-3">
                            <label class="form-label small">Tipo Cambio</label>
                            <InputNumber @bind-Value="project.TypeOfChange" class="form-control form-control-sm" />
                            <ValidationMessage For="@(() => project.TypeOfChange)" />
                        </div>

                        <div class="col-md-3">
                            <label class="form-label small">Oferta</label>
                            <InputText @bind-Value="project.OfferId" class="form-control form-control-sm" />
                            <ValidationMessage For="@(() => project.OfferId)" />
                        </div>

                        <div class="col-md-3">
                            <label class="form-label small">Orden Compra</label>
                            <InputText @bind-Value="project.OC" class="form-control form-control-sm" />
                            <ValidationMessage For="@(() => project.OC)" />
                        </div>

                        <div class="col-md-3">
                            <label class="form-label small">Fecha OC</label>
                            <InputDate @bind-Value="project.OCDate" class="form-control form-control-sm" />
                            <ValidationMessage For="@(() => project.OCDate)" />
                        </div>
                    </div>
                </div>
                <hr />
                <!-- ESTADO -->
                <div class="mb-4">
                    <h6 class="text-muted small fw-semibold mb-3">ESTADO</h6>

                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label small">Estado</label>
                            <InputSelect @bind-Value="project.StateId" class="form-select form-select-sm">
                                <option value="">Seleccionar</option>
                                @foreach (var item in States)
                                {
                                    <option value="@item.Key">@item.Value</option>
                                }
                            </InputSelect>
                            <ValidationMessage For="@(() => project.StateId)" />
                        </div>

                        <div class="col-md-4">
                            <label class="form-label small">Tipo Proyecto</label>
                            <InputSelect @bind-Value="project.TypeId" class="form-select form-select-sm">
                                <option value="">Seleccionar</option>
                                @foreach (var item in types)
                                {
                                    <option value="@item.Key">@item.Value</option>
                                }
                            </InputSelect>
                            <ValidationMessage For="@(() => project.TypeId)" />
                        </div>

                        <div class="col-md-4">
                            <label class="form-label small">Vendedor</label>
                            <InputSelect @bind-Value="project.SellerId" class="form-select form-select-sm">
                                @foreach (var item in sellers)
                                {
                                    <option value="@item.SellerId">@item.SellerName</option>
                                }
                            </InputSelect>
                        </div>
                    </div>
                </div>
                <hr />
                <!-- ACCIONES -->
                <div class="d-flex justify-content-end gap-2 pt-3 border-top">
                    <button type="button" class="btn btn-sm btn-light" @onclick="CancelEdit">
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-sm btn-primary">
                        Actualizar
                    </button>
                </div>

            </div>
        </div>
    </EditForm>

}
else
{
    <div class="card border-0 shadow-sm">
        <div class="card-body px-4 py-3">

            <!-- INFO -->
            <div class="mb-3">
                <div class="text-muted small fw-semibold mb-2">
                    INFORMACIÓN DEL PROYECTO
                </div>

                <div class="d-flex py-1 border-bottom">
                    <div class="text-muted small w-25">Número</div>
                    <div class="fw-semibold">@project.ProjectId</div>
                </div>

                <div class="d-flex py-1 border-bottom">
                    <div class="text-muted small w-25">Título</div>
                    <div class="fw-semibold">@project.Title</div>
                </div>

                <div class="d-flex py-1 border-bottom">
                    <div class="text-muted small w-25">Descripción</div>
                    <div class="text-muted">@project.Description</div>
                </div>

                <div class="d-flex py-1">
                    <div class="text-muted small w-25">Tipo</div>
                    <div class="text-muted">@project.Type.Name</div>
                </div>

            </div>

            <!-- RELACIONES -->
            <div class="mb-3 pt-2 border-top">
                <div class="text-muted small fw-semibold mb-2">
                    RELACIONES
                </div>

                <div class="d-flex py-1 border-bottom">
                    <div class="text-muted small w-25">Tarea</div>
                    <a class="fw-semibold text-decoration-none"
                       target="_blank"
                       href="https://grupomecsa.bitrix24.es/company/personal/user/107/tasks/task/view/@project.TaskNumber/">
                        @project.TaskNumber
                    </a>
                </div>

                <div class="d-flex py-1 border-bottom">
                    <div class="text-muted small w-25">Cliente</div>
                    <a class="fw-semibold text-decoration-none"
                       href="/customers/@project.CustomerId">
                        @project.Customer?.Name
                    </a>
                </div>

                <div class="d-flex py-1 border-bottom">
                    <div class="text-muted small w-25">Compañía</div>
                    <div>@project.Company.CompanyName</div>
                </div>

                <div class="d-flex py-1">
                    <div class="text-muted small w-25">Encargado</div>
                    <div>@project.Seller.SellerName</div>
                </div>
            </div>

            <!-- COMERCIAL -->
            <div class="mb-3 pt-2 border-top">
                <div class="text-muted small fw-semibold mb-2">
                    DATOS COMERCIALES
                </div>

                <div class="row g-2">
                    <div class="col-md-3">
                        <div class="text-muted small">Monto</div>
                        <div class="fw-semibold">
                            @if (project.CurrencyType.Equals("ES-CR"))
                            {
                                <label>₡ @project.Amount.ToString("N2") </label>
                            }
                            else
                            {
                                <label>	$ @project.Amount.ToString("N2")</label>
                            }
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-muted small">Tipo Cambio</div>
                        <div>@project.TypeOfChange</div>
                    </div>

                    <div class="col-md-3">
                        <div class="text-muted small">Oferta</div>
                        <div>@project.OfferId</div>
                    </div>

                    <div class="col-md-3">
                        <div class="text-muted small">OC</div>
                        <div>@project.OC</div>
                    </div>

                    <div class="col-md-3">
                        <div class="text-muted small">Fecha OC</div>
                        <div>@project.OCDate.ToLongDateString()</div>
                    </div>
                </div>
            </div>

            <!-- ESTADO -->
            <div class="pt-2 border-top">
                <div class="text-muted small fw-semibold mb-2">
                    ESTADO
                </div>

                <div class="d-flex gap-4 flex-wrap">
                    <div>
                        <div class="text-muted small">Proyecto</div>
                        <span class="badge bg-light text-dark">
                            @project.State?.StateName
                        </span>
                    </div>

                    <div>
                        <div class="text-muted small">Facturación</div>
                        @if (project.Isfactured)
                        {
                            <span class="badge bg-success-subtle text-success">
                                Facturado
                            </span>
                        }
                        else
                        {
                            <span class="badge bg-warning-subtle text-warning">
                                Pendiente
                            </span>
                        }
                    </div>

                    <div>
                        <div class="text-muted small">Completado</div>
                        @if (project.IsCompleted)
                        {
                            <span class="badge bg-success-subtle text-success">
                                Completo
                            </span>
                        }
                        else
                        {
                            <span class="badge bg-secondary-subtle text-secondary">
                                Incompleto
                            </span>
                        }
                    </div>
                </div>
            </div>

        </div>
    </div>


    <div class="d-flex flex-row  mt-3 gap-2">
        <AuthorizeView Roles="administrador,ingeniero,contabilidad">
            <Authorized>

                <div>
                    @if (!project.IsDeleted)
                    {
                        <button class="btn btn-sm btn-outline-info" @onclick="StartEdit">Editar Proyecto</button>
                    }
                </div>
                <div>
                    @if (!project.Isfactured)
                    {
                        <button class="btn btn-sm btn-outline-success" @onclick="() => { UpdateIsFactured(true); }">Facturación Completa</button>
                    }
                    @if (project.Isfactured)
                    {
                        <button class="btn btn-sm btn-outline-warning" @onclick="() => { UpdateIsFactured(false); }">Facturación Incompleta</button>
                    }
                </div>
                <div>
                    @if (!project.IsCompleted)
                    {
                        <button class="btn btn-sm btn-outline-success" @onclick="() => { UpdateIsComplete(true); }">Marcar como Completo (Operativamente)</button>
                    }
                    @if (project.IsCompleted)
                    {
                        <button class="btn btn-sm btn-outline-warning" @onclick="() => { UpdateIsComplete(false); }">Marcar Como Incompleto</button>
                    }
                </div>


            </Authorized>
        </AuthorizeView>
        <div>
            <button class="btn btn-sm btn-outline-warning" @onclick="Download">
                <Icon Name="IconName.Download"></Icon> Descargar Información
            </button>

        </div>
    </div>



}

@code {

    #region Parameters

    [Parameter]
    public Project project { get; set; }
    private bool IsEditing = false;

    private string? customerName;

    CultureInfo AmountCulture;

    private Dictionary<int, string> customers = new();
    private Dictionary<int, string> types = new();
    private Dictionary<int, string> filteredCustomers = new();
    private Dictionary<int, string> States = new();
    List<Seller> sellers = new();
    List<Company> companies = new();

    private string searchCustomer = "";

    #endregion

    #region Methods

    protected override async Task OnInitializedAsync()
    {
        AmountCulture = new CultureInfo(project.CurrencyType);
        companies = db.Company.ToList();
        sellers = db.Seller
        .Where(e => e.IsActive)
        .OrderBy(e => e.SellerName)
        .ToList();
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        customers = await db.Customers.ToDictionaryAsync(e => e.CustomerId, r => r.Name);
        types = await db.Types.ToDictionaryAsync(e => e.TypeId, r => r.Name);
        filteredCustomers = customers; // Inicialmente, todos los clientes están disponibles
        States = await db.States
            .Where(i => !i.IsDeleted)
            .OrderByDescending(e => e.StateName)
            .ToDictionaryAsync(e => e.StateId, r => r.StateName);
    }

    private async Task<AutoCompleteDataProviderResult<Customer>> CustomersDataProvider(AutoCompleteDataProviderRequest<Customer> request)
    {
        var customersf = db.Customers.Where(w => w.Name.Contains(request.Filter.Value));
        return await Task.FromResult(new AutoCompleteDataProviderResult<Customer> { Data = customersf, TotalCount = customersf.Count() });
    }

    private void OnAutoCompleteChanged(Customer customer)
    {
        if (customer != null)
        {
            customerName = customer.Name;
            project.Customer = customer;
            project.CustomerId = customer.CustomerId;
        }
    }

    private void StartEdit()
    {
        IsEditing = true;
        customerName = project.Customer.Name;
    }

    private void CancelEdit()
    {
        IsEditing = false;
    }

    private async Task Update()
    {
        try
        {
            var dbtmp = DbContextFactory.CreateDbContext();
            if (project != null)
            {
                // Desvincula relaciones si es necesario
                project.Seller = dbtmp.Seller.FirstOrDefault(e => e.SellerId == project.SellerId);
                project.State = dbtmp.States.FirstOrDefault(e => e.StateId == project.StateId);
                project.Customer = dbtmp.Customers.FirstOrDefault(e => e.CustomerId == project.CustomerId);
                project.Type = dbtmp.Types.FirstOrDefault(e => e.TypeId == project.TypeId);
                dbtmp.Projects.Update(project);
                await dbtmp.SaveChangesAsync();

                // Recargar el objeto desde la base de datos
                project = await dbtmp.Projects
                    .Include(p => p.Customer)
                    .Include(p => p.State)
                    .Include(p => p.Type)
                    .FirstOrDefaultAsync(p => p.ProjectId == project.ProjectId);

                IsEditing = false;
            }
        }
        catch (Exception ex)
        {
            // Manejar el error de actualización aquí
            Console.WriteLine($"Error al actualizar el proyecto: {ex.Message}");
        }
    }

    private async Task UpdateIsComplete(bool state)
    {
        var dbtmp = DbContextFactory.CreateDbContext();
        project.IsCompleted = state;
        dbtmp.Projects.Update(project);
        dbtmp.SaveChanges();
    }

    private async Task UpdateIsFactured(bool state)
    {
        var dbtmp = DbContextFactory.CreateDbContext();
        project.Isfactured = state;
        dbtmp.Projects.Update(project);
        dbtmp.SaveChanges();
    }

    private async Task Download()
    {
        project.Bills = db.Bill.Where(e => e.ProjectId == project.ProjectId).ToList();
        var data = await PDFGenerate.PDFProjectReport(project);
        // Convertir los bytes del PDF a una cadena base64 para pasarlos a JavaScript
        string pdfBase64 = Convert.ToBase64String(data);

        // Invocar una función JavaScript para iniciar la descarga del PDF
        await JS.InvokeVoidAsync("downloadPDF", pdfBase64, $"Proyecto {project.Title} {DateTime.Now.ToShortTimeString()}.pdf");


    }


    #endregion
}
