@inject ProjectsDBContext db

<BarChart @ref="barChart" Width="500" Height="300" />

@code {
    private BarChart barChart = default!;
    private BarChartOptions barChartOptions = default!;
    private ChartData chartData = default!;


    private List<string> GetLabelsStates()
    {
        return db.States.Select(w => w.StateName).ToList();
    }
    private List<double?> GetCountByState(List<string> states)
    {
        // Obtener todos los proyectos y convertir a una lista en memoria
        var projects = db.Projects.ToList();

        // Obtener todos los estados y convertir a una lista en memoria
        var stateList = db.States.ToList();

        // Crear un diccionario que mapea StateId a la cantidad de proyectos
        var projectCountsByState = projects
            .GroupBy(p => p.StateId) // Agrupar proyectos por StateId
            .ToDictionary(
                g => g.Key, // La clave es StateId
                g => (double?)g.Count() // El valor es la cantidad de proyectos como double?
            );

        // Crear un diccionario que mapea el nombre del estado a StateId
        var stateIds = stateList
            .Where(s => states.Contains(s.StateName)) // Filtrar estados que están en la lista de estados
            .ToDictionary(
                s => s.StateName, // La clave es el nombre del estado
                s => s.StateId // El valor es el StateId
            );

        // Crear la lista de conteos de proyectos basada en los StateIds
        var values = states
            .Select(state =>
            {
                // Obtener el StateId para el nombre del estado
                if (stateIds.TryGetValue(state, out var stateId))
                {
                    // Obtener el conteo de proyectos para el StateId
                    return projectCountsByState.TryGetValue(stateId, out var count) ? count : (double?)null;
                }
                return (double?)null; // Si no se encuentra el StateId, devolver null
            })
            .ToList();

        return values;
    }


    protected override void OnInitialized()
    {
        var labels = GetLabelsStates();
        var datasets = new List<IChartDataset>();

        var dataset1 = new BarChartDataset()
            {
                Data = GetCountByState(labels),
                BackgroundColor = new List<string> { ColorUtility.CategoricalTwelveColors[0] },
                BorderColor = new List<string> { ColorUtility.CategoricalTwelveColors[0] },
                BorderWidth = new List<double> { 0 },
            };
        datasets.Add(dataset1);

        chartData = new ChartData { Labels = labels, Datasets = datasets };

        barChartOptions = new BarChartOptions();
        barChartOptions.Responsive = true;
        barChartOptions.Interaction = new Interaction { Mode = InteractionMode.Y };
        barChartOptions.IndexAxis = "y";

        barChartOptions.Scales.X!.Title = new ChartAxesTitle { Text = "Visitors", Display = true };
        barChartOptions.Scales.Y!.Title = new ChartAxesTitle { Text = "Browser", Display = true };

        barChartOptions.Plugins.Legend.Display = false;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await barChart.InitializeAsync(chartData, barChartOptions);
        }
        await base.OnAfterRenderAsync(firstRender);
    }
}

