@inject IDbContextFactory<ProjectsDBContext> DbContextFactory

@if (SelectedSchedule is not null)
{
    <div class="p-2">

        <!-- #region GENERAL -->
        <div class="d-flex justify-content-between align-items-center my-2">
            <h4 class="mb-1 text-primary">
                Proyecto @SelectedSchedule.Project?.Title
            </h4>
            <label class="italic text-sm text-secondary">
                Número Proyecto: @SelectedSchedule.ProjectId
            </label>
        </div>

        <div class="d-flex justify-content-start align-items-center my-2">
            <a href="/projects/@SelectedSchedule.ProjectId" class="btn btn-sm btn-outline-info mx-2">
                Proyecto
            </a>

            <a href="https://grupomecsa.bitrix24.es/company/personal/user/107/tasks/task/view/@SelectedSchedule.Project.TaskNumber/"
               class="btn btn-sm btn-outline-primary mx-2"
               target="_blank">
                Tarea
            </a>
            <button class="btn btn-sm btn-outline-success mx-2" @onclick="StartEditDates">
                Editar
            </button>

            <button class="btn btn-sm btn-outline-danger mx-2" @onclick="DeleteSchedule">
                Borrar
            </button>
        </div>

        <hr />

        <div class="my-2">
            <h5 class="card-title text-primary">@SelectedSchedule.TaskName</h5>

            <!-- ⭐ MODO NORMAL -->
            @if (!editDates)
            {
                <table class="table table-sm">
                    <tbody>
                        <tr>
                            <td><b>Inicio:</b> @SelectedSchedule.Start.ToString("dd/MM/yyyy")</td>
                            <td><b>Fin:</b> @SelectedSchedule.End.ToString("dd/MM/yyyy")</td>
                        </tr>
                        <tr>
                            <td><b>Vehículo:</b></td>
                            <td>@SelectedSchedule.Car</td>
                        </tr>
                    </tbody>
                </table>


            }
            else
            {
                <!-- ⭐ MODO EDICIÓN -->
                <div class="border rounded p-3">
                    <div class="row">
                        <label class="form-label">Tarea:</label>
                        <input type="text" class="form-control"
                               @bind="TaskNameEdit" />
                    </div>


                    <div class="row">
                        <label class="form-label">Descripción</label>
                        <input type="text" class="form-control"
                               @bind="NotesEdit" />
                    </div>


                    <div class="row">
                        <div class="col-6">
                            <label class="form-label">Inicio</label>
                            <input type="date" class="form-control"
                                   @bind="editStart" />
                        </div>

                        <div class="col-6">
                            <label class="form-label">Fin</label>
                            <input type="date" class="form-control"
                                   @bind="editEnd" />
                        </div>

                    </div>

                    <div class="mt-3">
                        <button class="btn btn-primary btn-sm" @onclick="SaveDates">Guardar</button>
                        <button class="btn btn-secondary btn-sm ms-2" @onclick="CancelEditDates">Cancelar</button>
                    </div>

                </div>
            }

            @if (!string.IsNullOrWhiteSpace(SelectedSchedule.Notes))
            {
                <p class="mt-3">
                    <b>Notas:</b><br />
                    @SelectedSchedule.Notes
                </p>
            }
        </div>

        <!-- #endregion -->

        <hr />

        <!-- #region EMPLEADOS -->
        <div class="d-flex justify-content-between align-items-center my-2">
            <h5 class="text-primary">Empleados Asignados</h5>

            <button class="btn btn-sm btn-primary" @onclick="() => showAddEmployee = true">
                Agregar Empleado
            </button>
        </div>

        @if (EmployeesBySchedule.Count == 0)
        {
            <p class="text-muted">No hay empleados asignados.</p>
        }
        else
        {
            <table class="table table-sm align-middle">
                <thead>
                    <tr>
                        <th>Empleado</th>
                        <th>Posición</th>
                        <th>Teléfono</th>
                        <th style="width: 80px;"></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var se in EmployeesBySchedule)
                    {
                        <tr>
                            <td>@se.Employee.FirstName @se.Employee.LastName</td>
                            <td>@se.Employee.Position</td>
                            <td>@se.Employee.PhoneNumber</td>
                            <td>
                                <button class="btn btn-sm btn-danger"
                                        @onclick="() => DeleteEmployee(se.SchEmplId)">
                                    Quitar
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        <!-- #endregion -->
        <!-- #region MODAL AGREGAR EMPLEADO -->
        <!-- #region Devices-->
        <div class="d-flex justify-content-between align-items-center my-2">
            <h5 class="text-primary">Equipos Asignados</h5>
        </div>

        @foreach (var i in SelectedSchedule.SchDevs)
        {
            <div>
                <label>
                    @i.Device.DeviceName
                </label>
                <button class="btn btn-sm btn-danger"
                        @onclick="() => DeleteDevice(i.SchDevId)">
                    Quitar
                </button>
            </div>
        }

        <!-- #endregion -->
        @if (showAddEmployee)
        {
            <div class="modal fade show d-block" tabindex="-1"
                 style="background-color: rgba(0,0,0,0.4);">
                <div class="modal-dialog">
                    <div class="modal-content">

                        <div class="modal-header">
                            <h5 class="modal-title">Agregar Empleado</h5>
                            <button class="btn-close" @onclick="CloseAddEmployee"></button>
                        </div>

                        <div class="modal-body">
                            <label class="form-label">Seleccione un empleado</label>
                            <select class="form-select" @bind="selectedEmployeeId">
                                <option value="">Seleccione</option>
                                @foreach (var emp in allEmployees)
                                {
                                    <option value="@emp.EmployeeId">
                                        @emp.FirstName @emp.LastName (@emp.Position)
                                    </option>
                                }
                            </select>
                        </div>

                        <div class="modal-footer">
                            <button class="btn btn-secondary" @onclick="CloseAddEmployee">Cancelar</button>
                            <button class="btn btn-primary" @onclick="AddEmployee">Agregar</button>
                        </div>

                    </div>
                </div>
            </div>
        }
        <!-- #endregion -->

    </div>
}
else
{
    <div class="text-muted p-3">
        No hay schedule seleccionado.
    </div>
}

@code {

    [Parameter] public Schedule SelectedSchedule { get; set; }
    [Parameter] public EventCallback OnHideOffcanvas { get; set; }

    private List<SchEmpl> EmployeesBySchedule = new();
    private List<Employee> allEmployees = new();

    private bool showAddEmployee = false;
    private int? selectedEmployeeId;

    //  Variables para edición de fechas
    private bool editDates = false;
    private DateTime editStart;
    private DateTime editEnd;
    private string NotesEdit;
    private string TaskNameEdit;

    //  SE EJECUTA CADA VEZ QUE CAMBIA SELECTEDSCHEDULE
    protected override async Task OnParametersSetAsync()
    {
        if (SelectedSchedule == null)
            return;

        using var db = await DbContextFactory.CreateDbContextAsync();

        EmployeesBySchedule = await db.Schedule_Employee
            .Where(se => se.ScheduleId == SelectedSchedule.ScheduleId)
            .Include(se => se.Employee)
            .ToListAsync();

        allEmployees = await db.Employees.ToListAsync();
    }

    //  Acciones para edición de fechas
    private void StartEditDates()
    {
        editStart = SelectedSchedule.Start;
        editEnd = SelectedSchedule.End;
        TaskNameEdit = SelectedSchedule.TaskName;
        NotesEdit = SelectedSchedule.Notes;
        editDates = true;
    }

    private void CancelEditDates()
    {
        editDates = false;
    }

    private async Task SaveDates()
    {
        using var db = await DbContextFactory.CreateDbContextAsync();

        var item = await db.Schedules
            .FirstOrDefaultAsync(s => s.ScheduleId == SelectedSchedule.ScheduleId);

        if (item != null)
        {
            item.Start = editStart;
            item.End = editEnd;
            item.TaskName = TaskNameEdit;
            item.Notes = NotesEdit;

            await db.SaveChangesAsync();

            // Actualizar UI
            SelectedSchedule.Start = editStart;
            SelectedSchedule.End = editEnd;
            SelectedSchedule.TaskName = TaskNameEdit;
            SelectedSchedule.Notes = NotesEdit;
        }

        editDates = false;
    }

    //  Empleados
    private void CloseAddEmployee()
    {
        showAddEmployee = false;
        selectedEmployeeId = null;
    }

    private async Task AddEmployee()
    {
        if (selectedEmployeeId == null)
            return;

        using var db = await DbContextFactory.CreateDbContextAsync();

        var newRelation = new SchEmpl
        {
            ScheduleId = SelectedSchedule.ScheduleId,
            EmployeeId = selectedEmployeeId.Value
        };

        db.Schedule_Employee.Add(newRelation);
        await db.SaveChangesAsync();

        await OnParametersSetAsync();
        CloseAddEmployee();
    }

    private async Task DeleteEmployee(int schEmplId)
    {
        using var db = await DbContextFactory.CreateDbContextAsync();

        var item = await db.Schedule_Employee.FindAsync(schEmplId);

        if (item != null)
        {
            db.Schedule_Employee.Remove(item);
            await db.SaveChangesAsync();
        }

        await OnParametersSetAsync();
    }


    private async Task DeleteSchedule()
    {
        try
        {
            using var db = await DbContextFactory.CreateDbContextAsync();

            var scheduleToDelete = await db.Schedules
                .FirstOrDefaultAsync(s => s.ScheduleId == SelectedSchedule.ScheduleId);

            var allDevicesSelected = db.Schedule_Device.Where(sd => sd.ScheduleId == SelectedSchedule.ScheduleId);
            db.Schedule_Device.RemoveRange(allDevicesSelected);

            var allEmployeseesSelected = db.Schedule_Employee.Where(se => se.ScheduleId == SelectedSchedule.ScheduleId);
            db.Schedule_Employee.RemoveRange(allEmployeseesSelected);

            db.Schedules.Remove(scheduleToDelete);
            await db.SaveChangesAsync();

            await OnParametersSetAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting device: {ex.Message}");
        }

        finally
        {
            await OnHideOffcanvas.InvokeAsync();
        }
    }

    private async Task DeleteDevice(int schDevId)
    {
        using var db = await DbContextFactory.CreateDbContextAsync();
        var item = await db.Schedule_Device.FindAsync(schDevId);
        if (item != null)
        {
            db.Schedule_Device.Remove(item);
            await db.SaveChangesAsync();
        }
        await OnParametersSetAsync();
    }
}
