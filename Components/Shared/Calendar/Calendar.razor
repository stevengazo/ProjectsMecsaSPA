@using ProjectsMecsaSPA.Model

<h3>Calendar</h3>

<div class="calendar-container">
    <div class="calendar-header">
        <button @onclick="PrevMonth">◀</button>
        <span>@CurrentMonth.ToString("MMMM yyyy")</span>
        <button @onclick="NextMonth">▶</button>
    </div>

    <div class="calendar-grid">

        @foreach (var day in WeekDays)
        {
            <div class="calendar-day-name">@day</div>
        }

        @foreach (var day in DaysInMonth)
        {
            // schedules que coinciden dentro del rango Start–End
            var daySchedules = SchedulesForMonth
            .Where(s => day.Date >= s.Start.Date && day.Date <= s.End.Date)
            .ToList();

            <div class="calendar-day @(day.Date == DateTime.Today ? "today" : "")">

                <div class="day-number">@day.Day</div>

                @if (daySchedules.Any())
                {
                    <div class="schedules">
                        @foreach (var sch in daySchedules)
                        {
                            <div class="schedule-item">
                                @sch.TaskName
                            </div>
                        }
                    </div>
                }
            </div>
        }
    </div>
</div>

@code {
    // Schedules recibidos desde afuera (padre)
    [Parameter]
    public List<Schedule> Schedules { get; set; } = new();

    private DateTime CurrentMonth = new(DateTime.Today.Year, DateTime.Today.Month, 1);
    private List<DateTime> DaysInMonth = new();

    // Schedules filtrados únicamente del mes visible
    private List<Schedule> SchedulesForMonth = new();

    private readonly string[] WeekDays =
        { "Lun", "Mar", "Mié", "Jue", "Vie", "Sáb", "Dom" };

    protected override void OnInitialized()
    {
        LoadCalendar();
        FilterSchedules();
    }

    // Se llama cuando cambian los parámetros que vienen del padre
    protected override void OnParametersSet()
    {
        FilterSchedules();
        StateHasChanged();
    }

    void FilterSchedules()
    {
        // Filtra sólo los schedules del mes visible en el calendario
        SchedulesForMonth = Schedules
            .Where(s =>
                s.Start.Month == CurrentMonth.Month ||
                s.End.Month == CurrentMonth.Month ||
                // caso: schedule cruza dos meses
                (s.Start < CurrentMonth.AddMonths(1) && s.End > CurrentMonth)
            )
            .ToList();
    }

    void LoadCalendar()
    {
        DaysInMonth.Clear();

        var first = CurrentMonth;
        int offset = ((int)first.DayOfWeek + 6) % 7; // lunes=0

        // Días previos
        for (int i = 0; i < offset; i++)
        {
            DaysInMonth.Add(first.AddDays(-(offset - i)));
        }

        // Días del mes actual
        int days = DateTime.DaysInMonth(CurrentMonth.Year, CurrentMonth.Month);
        for (int d = 1; d <= days; d++)
        {
            DaysInMonth.Add(new DateTime(CurrentMonth.Year, CurrentMonth.Month, d));
        }

        // Completar última fila
        while (DaysInMonth.Count % 7 != 0)
        {
            DaysInMonth.Add(DaysInMonth.Last().AddDays(1));
        }
    }

    void PrevMonth()
    {
        CurrentMonth = CurrentMonth.AddMonths(-1);
        LoadCalendar();
        FilterSchedules();
    }

    void NextMonth()
    {
        CurrentMonth = CurrentMonth.AddMonths(1);
        LoadCalendar();
        FilterSchedules();
    }
}
