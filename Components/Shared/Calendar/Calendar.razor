@using ProjectsMecsaSPA.Model



<div class="calendar-container">
    <div class="calendar-header">
        <button @onclick="PrevMonth">◀</button>
        <span>@CurrentMonth.ToString("MMMM yyyy")</span>
        <button @onclick="NextMonth">▶</button>
    </div>

    <div class="calendar-grid">
        @foreach (var day in WeekDays)
        {
            <div class="calendar-day-name">@day</div>
        }

        @foreach (var day in DaysInMonth)
        {
            var daySchedules = SchedulesForMonth
            .Where(s => day.Date >= s.Start.Date && day.Date <= s.End.Date)
            .ToList();

            <div class="calendar-day @(day.Date == DateTime.Today ? "today" : "")">

                <div class="day-number">@day.Day</div>

                @if (daySchedules.Any())
                {
                    <div class="schedules">
                        @foreach (var sch in daySchedules)
                        {
                            <div class="schedule-item"
                                 @onclick="() => OnScheduleClick(sch)"
                                 style="cursor:pointer">
                                @if (!string.IsNullOrEmpty(@sch.TaskName))
                                {

                                    @sch.ProjectId
                                    <label> - </label>

                                    @sch.Project?.Title
                                }
                                else
                                {
                                    <label> Sin titulo</label>
                                }
                            </div>
                        }
                    </div>
                }
            </div>
        }
    </div>
</div>
<Offcanvas @ref="offcanvas" title="Detalle">
    <BodyTemplate>
        <CalendarCanva SelectedSchedule="SelectedSchedule"  OnHideOffcanvas="OnHideOffcanvasClick" />
    </BodyTemplate>
</Offcanvas>



@code {

    private Offcanvas offcanvas = default!;

    // Únicamente Schedule seleccionado
    private Schedule? SelectedSchedule;

    private async Task OnHideOffcanvasClick()
        => await offcanvas.HideAsync();

    [Parameter]
    public List<Schedule> Schedules { get; set; } = new();

    private DateTime CurrentMonth = new(DateTime.Today.Year, DateTime.Today.Month, 1);
    private List<DateTime> DaysInMonth = new();
    private List<Schedule> SchedulesForMonth = new();

    private readonly string[] WeekDays =
        { "Lun", "Mar", "Mié", "Jue", "Vie", "Sáb", "Dom" };

    protected override void OnInitialized()
    {
        LoadCalendar();
        FilterSchedules();
    }

    protected override void OnParametersSet()
    {
        FilterSchedules();
        StateHasChanged();
    }

    private void FilterSchedules()
    {
        SchedulesForMonth = Schedules
            .Where(s =>
                s.Start.Month == CurrentMonth.Month ||
                s.End.Month == CurrentMonth.Month ||
                (s.Start < CurrentMonth.AddMonths(1) && s.End > CurrentMonth)
            )
            .ToList();
    }

    private void LoadCalendar()
    {
        DaysInMonth.Clear();

        var first = CurrentMonth;
        int offset = ((int)first.DayOfWeek + 6) % 7;

        for (int i = 0; i < offset; i++)
        {
            DaysInMonth.Add(first.AddDays(-(offset - i)));
        }

        int days = DateTime.DaysInMonth(CurrentMonth.Year, CurrentMonth.Month);
        for (int d = 1; d <= days; d++)
        {
            DaysInMonth.Add(new DateTime(CurrentMonth.Year, CurrentMonth.Month, d));
        }

        while (DaysInMonth.Count % 7 != 0)
        {
            DaysInMonth.Add(DaysInMonth.Last().AddDays(1));
        }
    }

    void PrevMonth()
    {
        CurrentMonth = CurrentMonth.AddMonths(-1);
        LoadCalendar();
        FilterSchedules();
    }

    void NextMonth()
    {
        CurrentMonth = CurrentMonth.AddMonths(1);
        LoadCalendar();
        FilterSchedules();
    }

    private async Task OnScheduleClick(Schedule sch)
    {
        SelectedSchedule = sch;
        await offcanvas.ShowAsync();
    }
}
