@page "/offer-edit"
@inject IDbContextFactory<ProjectsDBContext> DbContextFactory

@using System.ComponentModel.DataAnnotations

@if (IsEditing)
{
    <EditForm Model="tmpOffer" OnValidSubmit="Update">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <!-- ========================================================= -->
        <!-- INFORMACIÓN GENERAL -->
        <!-- ========================================================= -->
        <h5 class="text-center fw-bold mb-4">Información General</h5>

        <div class="p-2">
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="fw-semibold text-muted small">Número</div>
                    <div>@tmpOffer.OfferId</div>
                </div>

                <div class="col-md-4">
                    <div class="form-floating">
                        <InputDate class="form-control shadow-sm"
                                   @bind-Value="tmpOffer.Creation" />
                        <label>Fecha Registro</label>
                    </div>
                    <ValidationMessage For="@(() => tmpOffer.Creation)" class="text-danger small" />
                </div>

                <div class="col-md-4">
                    <div class="form-floating">
                        <InputText class="form-control shadow-sm"
                                   @bind-Value="tmpOffer.Customer" />
                        <label>Cliente</label>
                    </div>
                    <ValidationMessage For="@(() => tmpOffer.Customer)" class="text-danger small" />
                </div>
            </div>

            <div class="form-group mt-3">
                <div class="form-floating">
                    <InputTextArea class="form-control shadow-sm"
                                   @bind-Value="tmpOffer.Description" />
                    <label>Descripción</label>
                </div>
                <ValidationMessage For="@(() => tmpOffer.Description)" class="text-danger small" />
            </div>
        </div>

        <hr class="my-4" />

        <!-- ========================================================= -->
        <!-- CLASIFICACIÓN -->
        <!-- ========================================================= -->
        <h5 class="text-center fw-bold mb-4">Clasificación</h5>

        <div class="p-2">
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="form-floating">
                        <InputSelect class="form-control shadow-sm"
                                     @bind-Value="tmpOffer.ContactType">
                            <option value="">Seleccione</option>
                            <option value="Vendedor">Vendedor</option>
                            <option value="Reactivación">Reactivación</option>
                            <option value="Whatsapp">Whatsapp</option>
                            <option value="Correo">Correo</option>
                            <option value="Llamada">Llamada</option>
                            <option value="Otro">Otro</option>
                        </InputSelect>
                        <label>Tipo de Contacto</label>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="form-floating">
                        <InputSelect class="form-control shadow-sm"
                                     @bind-Value="tmpOffer.Type">
                            <option value="Mantenimiento">Mantenimiento</option>
                            <option value="Instalación">Instalación</option>
                            <option value="Mejoras">Mejoras</option>
                            <option value="Otro">Otro</option>
                        </InputSelect>
                        <label>Tipo de Oferta</label>
                    </div>
                    <ValidationMessage For="@(() => tmpOffer.Type)" class="text-danger small" />
                </div>
            </div>
        </div>

        <hr class="my-4" />

        <!-- ========================================================= -->
        <!-- REQUERIMIENTOS -->
        <!-- ========================================================= -->
        <h5 class="text-center fw-bold mb-4">Requerimientos</h5>

        <div class="p-2">
            <div class="form-check form-switch mb-2">
                <InputCheckbox class="form-check-input shadow-sm"
                               @bind-Value="tmpOffer.RequiredDDCE" />
                <label class="form-check-label fw-semibold">Vincular a DDCE</label>
            </div>

            <div class="form-check form-switch mb-2">
                <InputCheckbox class="form-check-input shadow-sm"
                               @bind-Value="tmpOffer.RequiredLightningStrike" />
                <label class="form-check-label fw-semibold">Vincular a Pararrayos</label>
            </div>

            <div class="form-check form-switch mb-2">
                <InputCheckbox class="form-check-input shadow-sm"
                               @bind-Value="tmpOffer.RequireTower" />
                <label class="form-check-label fw-semibold">Vincular a Torre</label>
            </div>

            <div class="form-check form-switch mb-2">
                <InputCheckbox class="form-check-input shadow-sm"
                               @bind-Value="tmpOffer.RequireSPAT" />
                <label class="form-check-label fw-semibold">Vincular a SPAT</label>
            </div>

            <div class="form-check form-switch mb-2">
                <InputCheckbox class="form-check-input shadow-sm"
                               @bind-Value="tmpOffer.RequireSurgeProtector" />
                <label class="form-check-label fw-semibold">Vincular a Supresores</label>
            </div>

            <div class="form-check form-switch">
                <InputCheckbox class="form-check-input shadow-sm"
                               @bind-Value="tmpOffer.RequireOther" />
                <label class="form-check-label fw-semibold">Vincular a Otros</label>
            </div>
        </div>

        <hr class="my-4" />

        <!-- ========================================================= -->
        <!-- DATOS COMERCIALES -->
        <!-- ========================================================= -->
        <h5 class="text-center fw-bold mb-4">Datos Comerciales</h5>

        <div class="p-2">
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="form-floating">
                        <InputNumber class="form-control shadow-sm"
                                     @bind-Value="tmpOffer.Amount" />
                        <label>Monto</label>
                    </div>
                    <ValidationMessage For="@(() => tmpOffer.Amount)" class="text-danger small" />
                </div>

                <div class="col-md-6">
                    <div class="form-floating">
                        <InputText class="form-control shadow-sm"
                                   @bind-Value="tmpOffer.CalculateBy" />
                        <label>Calculado Por</label>
                    </div>
                    <ValidationMessage For="@(() => tmpOffer.CalculateBy)" class="text-danger small" />
                </div>
            </div>

            <div class="row g-3 mt-1">
                <div class="col-md-6">
                    <div class="form-floating">
                        <InputSelect class="form-control shadow-sm"
                                     @bind-Value="tmpOffer.ResponsibleId">
                            @foreach (var item in sellers)
                            {
                                <option value="@item.SellerId">@item.SellerName</option>
                            }
                        </InputSelect>
                        <label>Responsable</label>
                    </div>
                    <ValidationMessage For="@(() => tmpOffer.ResponsibleId)" class="text-danger small" />
                </div>

                <div class="col-md-6">
                    <div class="form-floating">
                        <InputSelect class="form-control shadow-sm"
                                     @bind-Value="tmpOffer.State">
                            <option value="Enviado">Enviado</option>
                            <option value="Negociación">Negociación</option>
                            <option value="Pendiente">Pendiente</option>
                            <option value="Vendido">Vendido</option>
                            <option value="Cobro">Cobro</option>
                        </InputSelect>
                        <label>Etapa</label>
                    </div>
                    <ValidationMessage For="@(() => tmpOffer.State)" class="text-danger small" />
                </div>
            </div>
        </div>

        <!-- ========================================================= -->
        <!-- ACCIONES -->
        <!-- ========================================================= -->
        <div class="form-group mt-4 text-center">
            <button type="button"
                    class="btn btn-outline-danger btn-sm me-2"
                    @onclick="CancelEdit">
                Cancelar
            </button>

            <button type="submit"
                    class="btn btn-outline-info btn-sm">
                Actualizar
            </button>
        </div>

    </EditForm>

}
else
{
   <TableOfferComponent offer="offer" /> 
   <button class="btn btn-sm btn-outline-info" @onclick="StartEdit">Editar Oferta</button>
}

@errorMessage

@code {
    [Parameter]
    public Offer offer { get; set; }
    private bool IsEditing = false;
    private Offer tmpOffer = new();

    ProjectsDBContext projectsDB;

    string errorMessage = "";
    private List<Seller> sellers = new();
    protected override async Task OnInitializedAsync()
    {
        projectsDB = DbContextFactory.CreateDbContext();

        // Aquí puedes cargar datos iniciales si es necesario
        sellers = projectsDB.Seller.Where(e => e.IsActive).ToList();
    }

    private void StartEdit()
    {
        tmpOffer = offer;
        IsEditing = true;
    }

    private void CancelEdit()
    {
        IsEditing = false;
        tmpOffer = null;
        StateHasChanged();
    }

    private async Task Update()
    {
        try
        {
            if (tmpOffer != null)
            {
                offer = null;
                tmpOffer.Responsible = sellers.FirstOrDefault(i => i.DNI.ToString() == tmpOffer.ResponsibleId).SellerName;
                projectsDB.Offers.Update(tmpOffer);
                await projectsDB.SaveChangesAsync();
                offer = tmpOffer;

                IsEditing = false;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
            // Manejar el error de actualización aquí
            Console.WriteLine($"Error al actualizar la oferta: {ex.Message}");
        }
    }
}
