@inject ProjectsDBContext db

<!-- Authentication -->
@using Microsoft.AspNetCore.Components.Authorization
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IDbContextFactory<ApplicationDbContext> dbIdentityFactory

<Toasts class="p-3" Messages="messages" Placement="ToastsPlacement.TopRight" />


<div class="d-flex flex-row justify-content-between">
    <button class="btn btn-outline-success" @onclick="ShowAddOfferComponent">Agregar Oferta <Icon Name="IconName.File" /></button>
</div>

<div class="mt-3 bg-success text-white bg-opacity-75">
    @message
</div>
<Offcanvas @ref="offcanvas" />

@if (offers != null && offers.Any())
{
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>N</th>
                <th>Fecha</th>
                <th>Cliente</th>
                <th>Estado</th>
                <th>Responsable</th>
                <th>Descripción</th>
                <th>Monto</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var offer in offers)
            {
                <RowOfferComponent offer="offer"/>
            }
        </tbody>
    </table>
}
else
{
    <p>No hay ofertas disponibles.</p>
}

<Pagination ActivePageNumber="@currentPageNumber"
            TotalPages="@totalPages"
            PageChanged="OnPageChangedAsync" />

<text>Current Page Number: @currentPageNumber</text>

@code {
    private List<Offer> offers = new List<Offer>();
    private int currentPageNumber = 1;
    private int totalPages; 


    private Offcanvas offcanvas = default!;
    private string? message;
    List<ToastMessage> messages = new List<ToastMessage>();

    /// <summary>
    /// Get or Set the current user
    /// </summary>
    private string? CurrentUserName;

    /// <summary>
    /// Validate if the user is admin or not
    /// </summary>
    private bool IsAdmin;

    /// <summary>
    /// DNI of the responsible
    /// </summary>
    private int CurrentUserDNI;

    /// <summary>
    /// Database for the Identity Schema
    /// </summary>
    private ApplicationDbContext dbIdentity;



    protected override async Task OnInitializedAsync()
    {
        dbIdentity = dbIdentityFactory.CreateDbContext();
        await LoadUserContext();
        await LoadOffersAsync(currentPageNumber);
    }

    private async Task LoadOffersAsync(int pageNumber)
    {
        // Definir cuántas ofertas mostrar por página
        int pageSize = 100;

        // Obtener el total de ofertas para calcular el número total de páginas
        int totalOffers = db.Offers.Count();
        totalPages = (int)Math.Ceiling(totalOffers / (double)pageSize);

        var query = db.Offers.AsQueryable();

        if (!IsAdmin)
        {
            query = query.Where(e => e.ResponsibleId == CurrentUserDNI.ToString());
        }

        query = query.OrderByDescending(o => o.OfferId);
        query = query.Skip((pageNumber - 1) * pageSize);
        query = query.Take(pageSize);




        // Obtener las ofertas para la página actual
        offers = await query.ToListAsync();
    }

    private async Task OnPageChangedAsync(int newPageNumber)
    {
        currentPageNumber = newPageNumber;
        await LoadOffersAsync(currentPageNumber);
    }

    private async Task ShowAddOfferComponent()
    {
        // Crear un diccionario para pasar parámetros al componente AddProject
        var parameters = new Dictionary<string, object>
        {
            // Usar EventCallback.Factory.Create para crear un EventCallback para el método HandleProjectAdded
            { nameof(AddOffer.OnAdded), EventCallback.Factory.Create(this, HandleOfferAdded) }
        };

        // Mostrar el componente AddProject dentro del Offcanvas
        // El primer parámetro es el título del Offcanvas
        // El segundo parámetro es el diccionario de parámetros que contiene el EventCallback
        await offcanvas.ShowAsync<AddOffer>("Crear Oferta", parameters);
    }

    private async Task HandleOfferAdded()
    {

        await offcanvas.HideAsync();
        messages.Add(new()
            {
                Message = "Oferta Agregada",
                Type = ToastType.Success
            });

    }

    private async Task LoadUserContext()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (!user.Identity?.IsAuthenticated ?? true)
            return;

        CurrentUserName = user.Identity!.Name;

        IsAdmin = user.IsInRole("administrador");

        CurrentUserDNI = dbIdentity.Users.FirstOrDefault(e => e.UserName == CurrentUserName).DNI;

    }
}
