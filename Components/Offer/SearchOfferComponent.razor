@using ProjectsMecsaSPA.Model
@using ProjectsMecsaSPA.Utilities
@inject ProjectsDBContext DbContext
@inject ApplicationDbContext dbIdentity
@inject IDbContextFactory<ProjectsDBContext> dbContextFactory
@inject IJSRuntime JS

<!-- Authentication -->
@using Microsoft.AspNetCore.Components.Authorization
@inject AuthenticationStateProvider AuthenticationStateProvider
<!-- HEADER -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h3 class="mb-0">Buscar Ofertas</h3>
        <small class="text-muted">Filtre y gestione las ofertas registradas</small>
    </div>

    <Tooltip Title="Agregar Oferta">
        <button class="btn btn-sm btn-outline-success d-flex align-items-center gap-1"
                @onclick="ShowAddOfferComponent">
            <Icon Name="IconName.DatabaseAdd" />
            <span>Oferta</span>
        </button>
    </Tooltip>
</div>

<!-- Toast Message -->
<Toasts class="p-3" Messages="messages" Placement="ToastsPlacement.TopRight" />

<!-- Canvas -->
<Offcanvas @ref="offcanvas" />

<!-- FILTER CARD -->
<div class="card shadow-sm border-0 mb-3">
    <div class="card-body">
        <div class="row g-3 align-items-end">

            <!-- Número -->
            <div class="col-md-2">
                <div class="form-floating">
                    <input type="number"
                           class="form-control"
                           id="offerId"
                           @bind="SearchCriteria.OfferId" />
                    <label for="offerId">Número</label>
                </div>
            </div>

            <!-- Cliente -->
            <div class="col-md-3">
                <div class="form-floating">
                    <input type="text"
                           class="form-control"
                           id="customer"
                           @bind="SearchCriteria.Customer" />
                    <label for="customer">Cliente</label>
                </div>
                @if (!IsCustomerNameValid)
                {
                    <small class="text-danger">
                        Mínimo 5 caracteres
                    </small>
                }
            </div>

            <!-- Fecha -->
            @if (ValidInputs.EnableCreation)
            {
                <div class="col-md-2 d-flex align-items-center gap-2">
                    <div class="form-floating flex-grow-1">
                        <input type="month"
                               class="form-control"
                               id="creationDate"
                               @bind="SearchCriteria.Creation" />
                        <label for="creationDate">Creación</label>
                    </div>
                    <button class="btn btn-sm btn-outline-danger"
                            @onclick="() => ValidInputs.EnableCreation = false">
                        <Icon Name="IconName.X" />
                    </button>
                </div>
            }

            <!-- Tipo -->
            @if (ValidInputs.EnableType)
            {
                <div class="col-md-2 d-flex align-items-center gap-2">
                    <div class="form-floating flex-grow-1">
                        <select class="form-select" @bind="SearchCriteria.Type">
                            <option value="">Seleccionar</option>
                            <option value="Mantenimiento">Mantenimiento</option>
                            <option value="Instalacion">Instalación</option>
                            <option value="Mejoras">Mejoras</option>
                            <option value="Otro">Otro</option>
                        </select>
                        <label>Tipo</label>
                    </div>
                    <button class="btn btn-sm btn-outline-danger"
                            @onclick="() => ValidInputs.EnableType = false">
                        <Icon Name="IconName.X" />
                    </button>
                </div>
            }

            <!-- Estado -->
            @if (ValidInputs.EnableState)
            {
                <div class="col-md-2 d-flex align-items-center gap-2">
                    <div class="form-floating flex-grow-1">
                        <select class="form-select" @bind="SearchCriteria.State">
                            <option value="">Seleccionar</option>
                            <option value="Enviado">Enviado</option>
                            <option value="Negociación">Negociación</option>
                            <option value="Pendiente">Pendiente</option>
                            <option value="Vendido">Vendido</option>
                            <option value="Cobro">Cobro</option>
                        </select>
                        <label>Estado</label>
                    </div>
                    <button class="btn btn-sm btn-outline-danger"
                            @onclick="() => ValidInputs.EnableState = false">
                        <Icon Name="IconName.X" />
                    </button>
                </div>
            }

            <!-- Responsable -->
            @if (ValidInputs.EnableResponsible && IsAdmin)
            {
                <div class="col-md-2 d-flex align-items-center gap-2">
                    <div class="form-floating flex-grow-1">
                        <select class="form-select" @bind="SearchCriteria.Seller">
                            @foreach (var i in Sellers)
                            {
                                <option value="@i">@i</option>
                            }
                        </select>
                        <label>Responsable</label>
                    </div>
                    <button class="btn btn-sm btn-outline-danger"
                            @onclick="() => ValidInputs.EnableResponsible = false">
                        <Icon Name="IconName.X" />
                    </button>
                </div>
            }

            <!-- ADD FILTER BUTTONS -->
            <div class="col-md-12 d-flex gap-1 flex-wrap mt-2">
                @if (!ValidInputs.EnableCreation)
                {
                    <Tooltip Title="Fecha">
                        <button class="btn btn-sm btn-outline-success"
                                @onclick="() => ValidInputs.EnableCreation = true">
                            <Icon Name="IconName.Calendar2Date" />
                        </button>
                    </Tooltip>
                }

                @if (!ValidInputs.EnableState)
                {
                    <Tooltip Title="Estado">
                        <button class="btn btn-sm btn-outline-success"
                                @onclick="() => ValidInputs.EnableState = true">
                            <Icon Name="IconName.Check" />
                        </button>
                    </Tooltip>
                }

                @if (!ValidInputs.EnableType)
                {
                    <Tooltip Title="Tipo">
                        <button class="btn btn-sm btn-outline-success"
                                @onclick="() => ValidInputs.EnableType = true">
                            <Icon Name="IconName.Type" />
                        </button>
                    </Tooltip>
                }

                @if (!ValidInputs.EnableResponsible && IsAdmin)
                {
                    <Tooltip Title="Responsable">
                        <button class="btn btn-sm btn-outline-success"
                                @onclick="() => ValidInputs.EnableResponsible = true">
                            <Icon Name="IconName.People" />
                        </button>
                    </Tooltip>
                }
            </div>

        </div>
    </div>
</div>

<!-- ACTION BUTTONS -->
<div class="d-flex gap-2 justify-content-end">
    <button class="btn btn-outline-primary d-flex align-items-center gap-1"
            @onclick="SearchOffers">
        <Icon Name="IconName.Search" />
        Buscar
    </button>

    <button class="btn btn-outline-secondary"
            @onclick="ClearFilters">
        Limpiar
    </button>

    <button class="btn btn-outline-warning d-flex align-items-center gap-1"
            @onclick="DownloadReport">
        <Icon Name="IconName.Download" />
        Descargar
    </button>
</div>

<!-- Loading Spinner -->
@if (IsSearching)
{
    <div class="d-flex justify-content-center">
        <Spinner Type="SpinnerType.Dots" Class="me-3" Color="SpinnerColor.Success" />
    </div>
}
else
{
    @if (IsSearchPerformed && !Offers.Any())
    {
        <div class="text-danger mt-3">No se encontraron ofertas.</div>
    }

    @if (Offers != null && Offers.Any())
    {
        <h4>Resultados:</h4>
        <table class="table table-striped table-hover mt-3">
            <thead>
                <tr>
                    <th>N</th>
                    <th>Fecha</th>
                    <th>Cliente</th>
                    <th>Estado</th>
                    <th>Autor</th>
                    <th>Descripción</th>
                    <th>Monto</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var offer in Offers)
                {
                    <RowOfferComponent offer="offer" />
                }
            </tbody>
        </table>
    }
}

@if (!string.IsNullOrEmpty(ErrorMessage))
{
    <div class="text-danger mt-3">@ErrorMessage</div>
}

@code {

    #region Properties

    private List<Offer> Offers { get; set; } = new List<Offer>();

    private const int MaxResults = 1500; // Límite de resultados

    private OfferSearchCriteria SearchCriteria { get; set; } = new OfferSearchCriteria();

    private bool IsCustomerNameValid { get; set; } = true;

    private bool IsSearchPerformed { get; set; } = false;

    private bool IsSearching { get; set; } = false;

    private string ErrorMessage { get; set; }

    private SearchInputs ValidInputs = new();

    private Offcanvas offcanvas = default!;

    private List<string> Sellers = new();

    private string? message;

    List<ToastMessage> messages = new List<ToastMessage>();

    /// <summary>
    /// Get or Set the current user
    /// </summary>
    private string? CurrentUserName;
    /// <summary>
    /// Validate if the user is admin or not
    /// </summary>
    private bool IsAdmin;
    /// <summary>
    /// DNI of the responsible
    /// </summary>
    private int CurrentUserDNI;

    #endregion

    #region Methods

    private async Task ShowAddOfferComponent()
    {
        // Crear un diccionario para pasar parámetros al componente AddProject
        var parameters = new Dictionary<string, object>
        {
            // Usar EventCallback.Factory.Create para crear un EventCallback para el método HandleProjectAdded
            { nameof(AddOffer.OnAdded), EventCallback.Factory.Create(this, ()=>{ } )}
        };

        // Mostrar el componente AddProject dentro del Offcanvas
        // El primer parámetro es el título del Offcanvas
        // El segundo parámetro es el diccionario de parámetros que contiene el EventCallback
        await offcanvas.ShowAsync<AddOffer>("Crear Oferta", parameters);
    }

    private async Task SearchOffers()
    {
        try
        {
            IsSearching = true;
            ValidateCustomerName();

            if (!IsCustomerNameValid)
            {
                Offers.Clear();
                return;
            }

            var query = DbContext.Offers.AsQueryable();

            if (SearchCriteria.OfferId.HasValue)
                query = query.Where(o => o.OfferId == SearchCriteria.OfferId);

            if (!string.IsNullOrEmpty(SearchCriteria.Customer))
                query = query.Where(o => o.Customer.Contains(SearchCriteria.Customer));

            if (SearchCriteria.Creation.HasValue && ValidInputs.EnableCreation)
                query = query.Where(o => o.Creation.Year == SearchCriteria.Creation.Value.Year
                    && o.Creation.Month == SearchCriteria.Creation.Value.Month);

            if (!string.IsNullOrEmpty(SearchCriteria.Type) && ValidInputs.EnableType)
                query = query.Where(o => o.Type == SearchCriteria.Type);

            if (!string.IsNullOrEmpty(SearchCriteria.State) && ValidInputs.EnableState)
                query = query.Where(o => o.State.Contains(SearchCriteria.State));

            if (!string.IsNullOrEmpty(SearchCriteria.Seller) && ValidInputs.EnableResponsible)
                query = query.Where(o => o.Responsible == SearchCriteria.Seller);

            if(!IsAdmin)
            {
                query = query.Where(r => r.ResponsibleId == CurrentUserDNI.ToString());
            }

            Offers = await query.Take(MaxResults).OrderByDescending(e => e.OfferId).ToListAsync();
            if (Offers.Count == MaxResults)
            {
                messages.Add(new()
                {
                    Message = "El sistema limito la cantidad de ofertas obtenidas",
                    Type = ToastType.Warning
                });
                messages.Add(new()
                {
                    Message = "Establezca filtros más especificos e intentelo de nuevo",
                    Type = ToastType.Warning
                });
            }
            IsSearchPerformed = true;
            ErrorMessage = Offers.Any() ? string.Empty : "No se encontraron ofertas.";
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Ocurrió un error al realizar la búsqueda: {ex.Message}";
        }
        finally
        {
            IsSearching = false;
        }
    }

    private async Task LoadSellers()
    {
        using (var dbTemp = dbContextFactory.CreateDbContext())
        {
            Sellers = dbTemp.Seller.Select(e => e.SellerName).ToList();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        LoadSellers();
        base.OnInitializedAsync();


        // Load the user data 
        LoadUserContext();
    }

    private async Task LoadUserContext()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (!user.Identity?.IsAuthenticated ?? true) 
            return;
        CurrentUserName = user.Identity!.Name;

        IsAdmin = user.IsInRole("administrador");

        using( var db = dbIdentity)
        {
            CurrentUserDNI = db.Users.FirstOrDefault(e => e.UserName == CurrentUserName).DNI;
        }
    }

    private void ValidateCustomerName()
    {
        IsCustomerNameValid = string.IsNullOrEmpty(SearchCriteria.Customer) || SearchCriteria.Customer.Length >= 5;
        if (!IsCustomerNameValid)
        {
            ErrorMessage = "El nombre del cliente debe tener al menos 5 caracteres.";
        }
    }

    private void ClearFilters()
    {
        SearchCriteria = new OfferSearchCriteria();
        Offers.Clear();
        IsSearchPerformed = false;
        ValidInputs = new();
        ErrorMessage = string.Empty;
    }

    private async Task DownloadReport()
    {
        var data = await XmlsGenerate.GenerateFileOffers(Offers);
        var pdfBase64 = Convert.ToBase64String(data);
        await JS.InvokeVoidAsync("downloadPDF", pdfBase64, $"Ofertas_{DateTime.Now:yyyyMMdd_HHmm}.xlsx");
    }

    private class OfferSearchCriteria
    {
        public int? OfferId { get; set; }
        public string Customer { get; set; }
        public DateTime? Creation { get; set; }
        public string Type { get; set; }
        public string Seller { set; get; }
        public string State { get; set; }
    }

    private class SearchInputs
    {
        public bool EnableCreation { get; set; }
        public bool EnableType { get; set; }
        public bool EnableState { set; get; }
        public bool EnableResponsible { get; set; }
    }


    #endregion
}
