@using ProjectsMecsaSPA.Components.Shared
@inject Bitrix24ClientService Bitrix24Client

@inject ProjectsDBContext db

<h6 class="text-end">
    <strong>Monto Facturado: </strong> @Bills.Sum(e => e.Amount).ToString("N2")
</h6>


<DeleteReasonDialog @ref="deleteDialog" />

<table class="table table-hover">
    <thead>
        <tr class="">
            <td><strong>Numero</strong></td>
            <td><strong>Fecha</strong></td>
            <td><strong>Autor</strong></td>
            <td><strong>Monto</strong></td>
            <td><strong>Nota</strong></td>
            <td><strong>Acciones</strong></td>
        </tr>

    </thead>
    <tbody>
        @foreach (var item in Bills)
        {
            <BillRowComponent item="item" OnDelete="() => RemoveBill(item)" />
        }
    </tbody>
</table>


@code {

    [Parameter]
    public List<Bill> Bills { get; set; }

    private DeleteReasonDialog deleteDialog = default!;

    private async Task RemoveBill(Bill bill)
    {
        var reason = await deleteDialog.ShowAsync();

        if (string.IsNullOrWhiteSpace(reason))
            return;

        bill.IsDeleted = true;
        bill.DeletedReason = reason;

        db.Bill.Update(bill);
        await db.SaveChangesAsync();

        Bills.Remove(bill);
        StateHasChanged();



        await Bitrix24Client.SendTaskCommentAsync(
             bill.TaskNumber,
             $"Se ha eliminado una factura desde el app de proyectos\n" +
             $"Número de factura: {bill.BillNumber}\n" +
             $"Proyecto: {bill.ProjectId}\n" +
             $"Monto: {bill.Amount}\n" +
             $"Motivo: {reason}",
             252);


    }


    protected override async Task OnInitializedAsync()
    {
        base.OnInitializedAsync();
    }
}
