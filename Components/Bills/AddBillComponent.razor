@page "/add-bill"
@using Newtonsoft.Json
@using ProjectsMecsaSPA.Model.Bitrix
@inject IWebHostEnvironment env
@inject IJSRuntime jS;
@inject FileStorageService FileStorageService
@inject Bitrix24ClientService Bitrix24Client
@inject IDbContextFactory<ProjectsDBContext> DbContextFactory

<style>
    .custom-file-input {
        all: unset;
    }

    .file-drop-zone {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        min-height: 140px;
        border: 1px dashed #adb5bd;
        border-radius: 10px;
        background-color: #f8f9fa;
        text-align: center;
        padding: 12px;
        cursor: pointer;
        transition: border-color .2s ease, background-color .2s ease;
    }

        .file-drop-zone:hover,
        .hover {
            border-color: #0d6efd;
            background-color: #eef4ff;
        }
</style>

<EditForm Model="bill" OnValidSubmit="Add">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <!-- ===================================== -->
    <!-- INFORMACIÓN DE FACTURA -->
    <!-- ===================================== -->
    <h5 class="text-center fw-bold mb-4">Información de la Factura</h5>

    <div class="p-2">
        <div class="row g-3">
            <div class="col-md-6">
                <div class="form-floating">
                    <InputText id="BillNumber" class="form-control shadow-sm"
                               @bind-Value="bill.BillNumber" />
                    <label for="BillNumber">Número de Factura</label>
                </div>
                <ValidationMessage For="@(() => bill.BillNumber)" class="text-danger small" />
            </div>

            <div class="col-md-6">
                <div class="form-floating">
                    <InputDate id="BillDate" class="form-control shadow-sm"
                               @bind-Value="bill.BillDate" />
                    <label for="BillDate">Fecha de Factura</label>
                </div>
                <ValidationMessage For="@(() => bill.BillDate)" class="text-danger small" />
            </div>
        </div>

        <div class="row g-3 mt-1">
            <div class="col-md-6">
                <div class="form-floating">
                    <InputNumber id="Amount" class="form-control shadow-sm"
                                 step="0.001" @bind-Value="bill.Amount" />
                    <label for="Amount">Importe</label>
                </div>
                <ValidationMessage For="@(() => bill.Amount)" class="text-danger small" />
            </div>

            <div class="col-md-6">
                <div class="form-floating">
                    <InputSelect class="form-select shadow-sm"
                                 @bind-Value="bill.Currency">
                        <option value="">Seleccione</option>
                        <option value="en-US">Dólar</option>
                        <option value="es-CR">Colón</option>
                    </InputSelect>
                    <label>Moneda</label>
                </div>
                <ValidationMessage For="@(() => bill.Currency)" class="text-danger small" />
            </div>
        </div>
    </div>

    <hr class="my-4" />

    <!-- ===================================== -->
    <!-- DATOS OPERATIVOS -->
    <!-- ===================================== -->
    <h5 class="text-center fw-bold mb-4">Datos Operativos</h5>

    <div class="p-2">
        <div class="row g-3">
            <div class="col-md-6">
                <div class="form-floating">
                    <InputNumber id="TaskNumber" class="form-control shadow-sm"
                                 @bind-Value="bill.TaskNumber" />
                    <label for="TaskNumber">Tarea de Facturación</label>
                </div>
                <ValidationMessage For="@(() => bill.TaskNumber)" class="text-danger small" />
            </div>

            <div class="col-md-6">
                <div class="form-floating">
                    <InputText id="Author" class="form-control shadow-sm"
                               @bind-Value="bill.Author" />
                    <label for="Author">Autor</label>
                </div>
                <ValidationMessage For="@(() => bill.Author)" class="text-danger small" />
            </div>
        </div>

        <div class="mt-3">
            <div class="form-floating">
                <InputTextArea id="Note" class="form-control shadow-sm"
                               @bind-Value="bill.Note" />
                <label for="Note">Nota</label>
            </div>
            <ValidationMessage For="@(() => bill.Note)" class="text-danger small" />
        </div>
    </div>

    <hr class="my-4" />

    <!-- ===================================== -->
    <!-- ARCHIVOS -->
    <!-- ===================================== -->
    <h5 class="text-center fw-bold mb-4">Archivos Adjuntos</h5>

    <div class="p-2">
        <div class="file-drop-zone mb-3">
            <p class="mb-2 text-muted">
                Arrastra archivos aquí o haz clic para seleccionarlos
            </p>

            <InputFile multiple
                       OnChange="OnChange"
                       @ondragenter="OnDragEnter"
                       @ondragleave="OnDragLeave"
                       @ondragover="OnDragEnter"
                       MaxFileSize="20971520"
                       class="@($"custom-file-input {HoverClass}")" />
        </div>

        @if (files.Any())
        {
            <div class="border rounded shadow-sm p-2">
                <h6 class="fw-semibold mb-2">Archivos por subir</h6>
                <ul class="list-unstyled mb-0">
                    @foreach (var file in files)
                    {
                        <li class="d-flex justify-content-between align-items-center border-bottom py-1">
                            <span class="small">@file.Name</span>
                            <button type="button"
                                    class="btn btn-sm btn-outline-danger"
                                    @onclick="() => DeleteFile(file)">
                                <Icon Name="IconName.Trash3Fill" />
                            </button>
                        </li>
                    }
                </ul>
            </div>
        }
    </div>

    <hr class="my-4" />

    <!-- ===================================== -->
    <!-- INTEGRACIÓN -->
    <!-- ===================================== -->
    <div class="p-2">
        <div class="d-flex justify-content-between align-items-center border rounded shadow-sm p-3">
            <span class="fw-semibold">Enviar datos al CRM</span>
            <InputCheckbox class="form-check-input"
                           @bind-Value="SendData" />
        </div>
    </div>

    <!-- ===================================== -->
    <!-- ACCIONES -->
    <!-- ===================================== -->
    <div class="text-center mt-4">
        <button type="submit" class="btn btn-outline-success px-5">
            Agregar Factura
        </button>

        @if (IsLoading)
        {
            <div class="mt-2">
                <Spinner Color="SpinnerColor.Success" />
            </div>
        }
    </div>
</EditForm>

<Toasts class="p-3" Messages="messages" Placement="ToastsPlacement.TopRight" />


@code {
    #region Parameter
    [Parameter]
    public int ProjectId { get; set; }
    [Parameter]
    public int FolderId { get; set; }

    [Parameter]
    public string CurrencyType { get; set; }
    [Parameter]
    public EventCallback OnAdded { get; set; }

    #endregion

    #region Properties
    private List<ToastMessage> messages = new List<ToastMessage>();
    private List<IBrowserFile> files = new();

    private bool IsLoading { get; set; } = false;
    private ElementReference fileDropContainer;
    private string HoverClass { get; set; } = string.Empty;
    private ProjectsDBContext db;

    Bill bill = new()
    {
        LastEditionDate = DateTime.Now,
        BillDate = DateTime.Now
    };

    private bool SendData { get; set; } = true;

    #endregion




    private void DeleteFile(IBrowserFile file)
    {
        files.Remove(file);
    }

    protected override Task OnInitializedAsync()
    {
        bill.Currency = CurrencyType;
        return base.OnInitializedAsync();
        bill.ProjectId = ProjectId;
    }

    private async Task Add()
    {
        IsLoading = true;   
        bill.LastEditor = "current_user"; // Reemplaza esto con el ID del usuario actual, si es necesario.
        bill.AuthorId = "";
        bill.Note = string.IsNullOrEmpty(bill.Note) ? "" : bill.Note;
        bill.Currency = CurrencyType;
        bill.ProjectId = ProjectId;
        db = DbContextFactory.CreateDbContext();
        db.Bill.Add(bill);
        await db.SaveChangesAsync();
        await UploadFiles();
        await SendCommentaryAsync();
        bill = new Bill
			{
				ProjectId = ProjectId,
				LastEditionDate = DateTime.Now,
				BillDate = DateTime.Now
			};
        IsLoading = false;
        files.Clear();
        this.StateHasChanged();


        await OnAdded.InvokeAsync(null);
    }

    void OnDragEnter(DragEventArgs e) => HoverClass = "hover";
    void OnDragLeave(DragEventArgs e) => HoverClass = string.Empty;

    async Task SendCommentaryAsync()
    {
        try
        {
            if(SendData){
                var files = db.BillFiles.Where(x => x.BillId == bill.BillId).Select(e => e.B24FileId).ToArray();
                if (bill.TaskNumber != 0)
                {
                    string Message = $"\nInformacion Ingresada en App de Proyectos \nMonto: {bill.Amount.ToString("n2")} \nMoneda: {bill.Currency} \nCreacion: {bill.BillDate} \nProyectoId: {bill.ProjectId} \nDescripcion: {bill.Note}\nTarea: {bill.TaskNumber}";
                    await Bitrix24Client.SendTaskCommentAsync(bill.TaskNumber, Message, 252, files);
                }
            }
        }
        catch (Exception ef)
        {
            Console.WriteLine(ef.Message);
        }
    }

    async Task UploadFiles()
    {
       try
        {
            await FileStorageService.GenerateBillDirectoryAsync(ProjectId, bill.BillNumber);
            foreach (var i in files)
            {
                BillFile tmpBill = new BillFile();
                tmpBill.FileName = i.Name;
                tmpBill.FilePath = await FileStorageService.UploadBillsFilesAsync(ProjectId, bill.BillNumber, i);
                tmpBill.FileExtension = Path.GetExtension(i.Name);
                tmpBill.Creation = DateTime.Now;
                tmpBill.BillId = bill.BillId;
                tmpBill.B24FileId = await TaskUploadFileToBitrixAsync(FolderId, tmpBill.FileName, tmpBill.FilePath);
                db.BillFiles.Add(tmpBill);
                await db.SaveChangesAsync();
            }
            files.Clear();
        }
        catch (Exception efe)
        {
			Console.WriteLine(efe.Message);
            
        }
    }

    async Task<string> TaskUploadFileToBitrixAsync(int folderId,string Name,string pathFile )
    {
        try{
            if (SendData)
            {
                byte[] fileBytes = await File.ReadAllBytesAsync(pathFile);
                var response = await Bitrix24Client.UploadFileAsync(folderId, Name, fileBytes);

                if (response != null)
                {
                    var ResponseObject = JsonConvert.DeserializeObject<BitrixFileResponse>(response);
                    return ResponseObject.result.ID.ToString();
                }
            }
            return "";
       }catch(Exception afs){
			Console.WriteLine(afs.Message);
			return "";
       }
	}

	async Task OnChange(InputFileChangeEventArgs e)
	{
		foreach (var file in e.GetMultipleFiles())
		{
			if (file.Size > 20971520)
			{
				messages.Add(new ToastMessage
					{
                        Type = ToastType.Warning,
						Message = $"El archivo {file.Name} excede el tamaño máximo permitido de 10MB.\nEl archivo no será cargado.",
						Title = "Advertencia"
					});
				continue;
			}else{
                files.Add(file);
            }
		}
	}

}
