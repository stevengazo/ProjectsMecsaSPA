@inject IDbContextFactory<ProjectsDBContext> DbContextFactory

<!-- Contenedor para la tabla de proyectos -->
<div>
    @if (Searching)
    {
        <div class="d-flex justify-content-center">
            <Spinner Type="SpinnerType.Border" />
        </div>
    }
    else
    {
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>N</th>
                    <th>Titulo</th>
                    <th>Cliente</th>
                    <th>Vendedor</th>
                    <th>Estado</th>
                    <th>OC</th>
                    <th>Compañia</th>
                    <th>Tipo</th>
                    <th>Creación</th>
                    <th>Monto</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                @if (projects?.Any() == true)
                {
                    @foreach (var project in projects)
                    {
                        <RowTableComponent ProjectObj="project" />
                    }
                }
                else
                {
                    <tr>
                        <td colspan="10" class="text-center text-muted">No hay proyectos registrados.</td>
                    </tr>
                }
            </tbody>
        </table>
    }
</div>

<Pagination ActivePageNumber="@CurrentPage"
            TotalPages="@TotalPages"
            DisplayPages="5"
            FirstLinkIcon="IconName.ChevronDoubleLeft"
            PreviousLinkIcon="IconName.ChevronLeft"
            NextLinkIcon="IconName.ChevronRight"
            LastLinkIcon="IconName.ChevronDoubleRight"
            PageChanged="LoadProjects" />

@code {
    private List<Project> projects = new();
    private bool Searching = true;

    private int CurrentPage { get; set; } = 1;
    private int PageSize { get; set; } = 25;
    private int TotalPages { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await LoadProjects(1);
    }

    private async Task LoadProjects(int pageNumber)
    {
        Searching = true;
        CurrentPage = pageNumber;

        using var db = await DbContextFactory.CreateDbContextAsync();

        var totalRecords = await db.Projects.Where
        (e => !e.RequiredCoordination).CountAsync();
        TotalPages = (int)Math.Ceiling(totalRecords / (double)PageSize);

        projects = await db.Projects
                .Include(p => p.State)
                    .Include(p => p.Customer)
                    .Include(p => p.Company)
                    .Include(p => p.Type)
        .Where
        (e => !e.RequiredCoordination)
            .OrderByDescending(p => p.CreationDate)
            .Skip((CurrentPage - 1) * PageSize)
            .Take(PageSize)
            .ToListAsync();

        Searching = false;
        StateHasChanged();
    }
}
