@page "/offers-by-author"

@inject ProjectsDBContext db
@inject IDbContextFactory<ProjectsDBContext> DbContextFactory

<PieChart @ref="pieChart" Width="500" />

@code {

    private PieChart pieChart = default!; // Referencia al componente PieChart para poder inicializarlo más tarde
    private PieChartOptions pieChartOptions = default!; // Opciones para configurar el gráfico de pastel
    private ChartData chartData = default!; // Datos para el gráfico de pastel
    private string[]? backgroundColors;  // Colores de fondo para las secciones del gráfico


    // Método que se ejecuta cuando el componente se inicializa
    protected override async void OnInitialized()
    {
        Dictionary<string,double?> dic = await GetData();
        List<string> labels = dic.Keys.ToList();

        var datasets = new List<IChartDataset>();

        var dataset = new PieChartDataset()
        {
                Data =dic.Values.ToList(),
                BackgroundColor = GenerateColors(dic.Values.Count),
                BorderColor = new List<string> { ColorUtility.CategoricalTwelveColors[0] },
                BorderWidth = new List<double> { 0 },

        };
        datasets.Add(dataset);
        chartData = new() {  Datasets= datasets, Labels=labels};



        // Inicializa los colores de fondo con una paleta predeterminada
        backgroundColors = ColorUtility.CategoricalTwelveColors;

        // Configura las opciones del gráfico de pastel
        pieChartOptions = new();
        pieChartOptions.Responsive = true;
        pieChartOptions.Plugins.Title!.Text = "Categorias 2024";
        pieChartOptions.Plugins.Title.Display = true;
    }

    private static readonly Random random = new Random();

    private List<string?> GenerateColors(int count)
    {
        List<string?> colors = new List<string?>();
        for (int i = 0; i < count; i++)
        {
            colors.Add(GenerateRandomColor());
        }
        return colors;
    }

    private string GenerateRandomColor()
    {
        return $"#{random.Next(0x1000000):X6}";
    }
    // Método que se ejecuta después de que el componente se ha renderizado
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Inicializa el gráfico de pastel con los datos y opciones configurados
            await pieChart.InitializeAsync(chartData, pieChartOptions);
        }
        await base.OnAfterRenderAsync(firstRender);
    }

    private async Task<Dictionary<string,double?>> GetData()
    {
        using (var db = DbContextFactory.CreateDbContext()){
        Dictionary<string, double?> dicOffers = new();
        var Labels = (from i in db.Offers
        select i.Author).Distinct().ToList();

        foreach (var item in Labels)
        {
            var count =(double) db.Offers.Where(d => d.Author == item).Count();
            dicOffers.Add(item, count);
        }

        return dicOffers;    
        }
        
    }




   
}
