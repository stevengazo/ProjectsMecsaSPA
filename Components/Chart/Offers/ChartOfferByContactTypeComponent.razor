@page "/offers-by-author"

@inject ProjectsDBContext db
@inject IDbContextFactory<ProjectsDBContext> DbContextFactory




<select @onchange="OnYearChanged" class="form-select">
    @foreach (var year in availableYears)
    {
        <option value="@year">@year</option>
    }
</select>

@if (Loading)
{
    <Spinner Color="SpinnerColor.Success" />
}
else
{
    <PieChart @ref="pieChart" Width="500" />
}



@code {
    private bool Loading = false;
    private PieChart pieChart = default!; // Referencia al componente PieChart para poder inicializarlo más tarde
    private PieChartOptions pieChartOptions = default!; // Opciones para configurar el gráfico de pastel
    private ChartData chartData = default!; // Datos para el gráfico de pastel
    private string[]? backgroundColors;  // Colores de fondo para las secciones del gráfico
    private List<int> availableYears = new List<int>();
    private static readonly Random random = new Random();

    private int SelectedYear = DateTime.Now.Year;

    // Método que se ejecuta cuando el componente se inicializa
    protected override async Task OnInitializedAsync()
    {

        await LoadYears();

        UpdateChartAsync();
    }

    private async Task LoadYears()
    {
        using (var dbtmp = DbContextFactory.CreateDbContext())
        {
            availableYears = dbtmp.Offers.AsNoTracking()
                                .Select(e => e.Creation.Year)
                                .Distinct()
                                .OrderByDescending(year=>year)
                                .ToList();

        }
    }

    private async Task OnYearChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var year))
        {
            SelectedYear = year;
            await UpdateChartAsync();
            StateHasChanged();
        }
    }

    private async Task UpdateChartAsync()
    {
        Loading = true;
        var datasets = new List<IChartDataset>();

        Dictionary<string, double?> dic = await GetData();
        List<string> labels = await GetLabels(dic);

        var dataset = new PieChartDataset()
            {
                Data = dic.Values.ToList(),
                BackgroundColor = GenerateColors(dic.Values.Count),
                BorderColor = new List<string> { ColorUtility.CategoricalTwelveColors[0] },
                BorderWidth = new List<double> { 0 },
            };

        datasets.Add(dataset);
        chartData = new() { Datasets = datasets, Labels = labels };
        // Inicializa los colores de fondo con una paleta predeterminada
        backgroundColors = ColorUtility.CategoricalTwelveColors;
        // Configura las opciones del gráfico de pastel
        pieChartOptions = new();
        pieChartOptions.Responsive = true;
        pieChartOptions.Plugins.Title!.Text = $"Categorias {SelectedYear}";
        pieChartOptions.Plugins.Title.Display = true;
        Loading = false;
        if(pieChart != null)
        {

            await pieChart.UpdateAsync(chartData, pieChartOptions);   
        }
        
    }

    private async Task<List<string>> GetLabels(Dictionary<string,double?> dic)
    {
        return dic.Keys.ToList();
    }

    private List<string?> GenerateColors(int count)
    {
        List<string?> colors = new List<string?>();
        for (int i = 0; i < count; i++)
        {
            colors.Add(GenerateRandomColor());
        }
        return colors;
    }

    private string GenerateRandomColor()
    {
        return $"#{random.Next(0x1000000):X6}";
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Inicializa el gráfico de pastel con los datos y opciones configurados
            await pieChart.InitializeAsync(chartData, pieChartOptions);
        }
        await base.OnAfterRenderAsync(firstRender);
    }

    private async Task<Dictionary<string, double?>> GetData()
    {
        using (var db = DbContextFactory.CreateDbContext())
        {
            Dictionary<string, double?> dicOffers = new();

            var Labels = (from i in db.Offers
                          where i.Creation.Year == DateTime.Now.Year
                          select i.Responsible).Distinct().ToList();

            foreach (var item in Labels)
            {
                var count = (double)db.Offers.Where(d => d.Responsible == item && d.Creation.Year == SelectedYear).Count();
                if(count > 0)
                {
                    dicOffers.Add(item, count);
                }
            }
            return dicOffers;
        }
    }
}
