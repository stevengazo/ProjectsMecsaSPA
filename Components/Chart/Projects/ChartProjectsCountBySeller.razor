
@inject ProjectsDBContext db

<h6>Proyectos por Vendedor</h6>

<select @onchange="OnYearChanged" class="form-select">
    @foreach (var year in availableYears)
    {
        <option value="@year">@year</option>
    }
</select>


<BarChart @ref="barChart" />

@code {
    private BarChart barChart = default!;
    private BarChartOptions barChartOptions = default!;
    private ChartData chartData = default!;
    private int selectedYear;
    private List<int> availableYears = new List<int>();

    protected override async Task OnInitializedAsync()
    {
        // Obtener los años disponibles desde los proyectos
        availableYears = await GetAvailableYearsAsync();
        if (availableYears.Any())
        {
            selectedYear = availableYears.First(); // Seleccionar el primer año por defecto
            await UpdateChartAsync();
        }
    }

    private async Task<List<int>> GetAvailableYearsAsync()
    {
        return await db.Projects
            .Select(p => p.CreationDate.Year)
            .Distinct()
            .OrderByDescending(year => year)
            .ToListAsync();
    }

    private List<string> GetLabelsSellers()
    {
        return db.Seller.Select(s => s.SellerName).ToList();
    }

    private List<double?> GetCountBySeller(List<string> sellers)
    {
        // Obtener todos los proyectos filtrados por el año seleccionado
        var projects = db.Projects
            .Where(p => p.CreationDate.Year == selectedYear) // Filtrar por el año seleccionado
            .ToList();

        // Obtener todos los vendedores y convertir a una lista en memoria
        var sellerList = db.Seller.ToList();

        // Crear un diccionario que mapea SellerId a la cantidad de proyectos
        var projectCountsBySeller = projects
            .GroupBy(p => p.SellerId) // Agrupar proyectos por SellerId
            .ToDictionary(
                g => g.Key, // La clave es SellerId
                g => (double?)g.Count() // El valor es la cantidad de proyectos como double?
            );

        // Crear un diccionario que mapea el nombre del vendedor a SellerId
        var sellerIds = sellerList
            .Where(s => sellers.Contains(s.SellerName)) // Filtrar vendedores que están en la lista de vendedores
            .ToDictionary(
                s => s.SellerName, // La clave es el nombre del vendedor
                s => s.SellerId // El valor es el SellerId
            );

        // Crear la lista de conteos de proyectos basada en los SellerIds
        var values = sellers
            .Select(seller =>
            {
                // Obtener el SellerId para el nombre del vendedor
                if (sellerIds.TryGetValue(seller, out var sellerId))
                {
                    // Obtener el conteo de proyectos para el SellerId
                    return projectCountsBySeller.TryGetValue(sellerId, out var count) ? count : (double?)null;
                }
                return (double?)null; // Si no se encuentra el SellerId, devolver null
            })
            .ToList();

        return values;
    }

    private async Task UpdateChartAsync()
    {
        var labels = GetLabelsSellers();
        var datasets = new List<IChartDataset>();

        var dataset1 = new BarChartDataset()
        {
            Data = GetCountBySeller(labels),
            BackgroundColor = new List<string> { ColorUtility.CategoricalTwelveColors[0] },
            BorderColor = new List<string> { ColorUtility.CategoricalTwelveColors[0] },
            BorderWidth = new List<double> { 0 },
        };
        datasets.Add(dataset1);

        chartData = new ChartData { Labels = labels, Datasets = datasets };

        barChartOptions = new BarChartOptions();
        barChartOptions.Responsive = true;
        barChartOptions.Interaction = new Interaction { Mode = InteractionMode.Y };
        barChartOptions.IndexAxis = "y";

        barChartOptions.Scales.X!.Title = new ChartAxesTitle { Text = "Número de Proyectos", Display = true };
        barChartOptions.Scales.Y!.Title = new ChartAxesTitle { Text = "Vendedores", Display = true };

        barChartOptions.Plugins.Legend.Display = false;
        
        if (barChart != null)
        {
            await barChart.InitializeAsync(chartData, barChartOptions);
        }

        barChart.UpdateAsync(chartData, barChartOptions);
    }

    private async Task OnYearChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var year))
        {
            selectedYear = year;
            await UpdateChartAsync();
        }
    }
}
