@inject IDbContextFactory<ProjectsDBContext> DbContextFactory

<h6>Monto Por Vendedor</h6>

<select @onchange="OnYearChanged" class="form-select">
    @foreach (var year in availableYears)
    {
        <option value="@year">@year</option>
    }
</select>

<BarChart @ref="barChart" />

@code {
    private BarChart barChart = default!;
    private BarChartOptions barChartOptions = default!;
    private ChartData chartData = default!;
    private int selectedYear;
    private List<int> availableYears = new List<int>();
    private ProjectsDBContext db;

    private bool _isInitialized = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_isInitialized)
        {
            _isInitialized = true;

            // Aquí es donde realizas las llamadas de interop a JavaScript
            await UpdateChartAsync();
        }
    }


    protected override async Task OnInitializedAsync()
    {
        db = DbContextFactory.CreateDbContext();
        availableYears = await GetAvailableYearsAsync();
        if (availableYears.Any())
        {
            selectedYear = availableYears.First();
          //  await UpdateChartAsync();
        }
    }

    private async Task<List<int>> GetAvailableYearsAsync()
    {
        return await db.Projects
            .Select(p => p.CreationDate.Year)
            .Distinct()
            .OrderByDescending(year => year)
            .ToListAsync();
    }

    private async Task<List<string>> GetLabelsSellersAsync()
    {
        return await db.Seller
            .Select(s => s.SellerName)
            .ToListAsync();
    }

    private async Task<List<double?>> GetAmountsBySellerAsync(List<string> sellers)
    {
        var projects = await db.Projects
            .Where(p => p.CreationDate.Year == selectedYear)
            .ToListAsync();

        var sellerList = await db.Seller.ToListAsync();

        var projectAmountsBySeller = projects
            .GroupBy(p => p.SellerId)
            .ToDictionary(
                g => g.Key,
                g => (double?)g.Sum(p => p.Amount)
            );

        var sellerIds = sellerList
            .Where(s => sellers.Contains(s.SellerName))
            .ToDictionary(
                s => s.SellerName,
                s => s.SellerId
            );

        var values = sellers
            .Select(seller =>
            {
                if (sellerIds.TryGetValue(seller, out var sellerId))
                {
                    return projectAmountsBySeller.TryGetValue(sellerId, out var totalAmount) ? totalAmount : (double?)null;
                }
                return (double?)null;
            })
            .ToList();

        return values;
    }

    private async Task UpdateChartAsync()
    {
        var labels = await GetLabelsSellersAsync();
        var datasets = new List<IChartDataset>();

        var dataset1 = new BarChartDataset()
            {
                Data = await GetAmountsBySellerAsync(labels),
                BackgroundColor = new List<string> { ColorUtility.CategoricalTwelveColors[0] },
                BorderColor = new List<string> { ColorUtility.CategoricalTwelveColors[0] },
                BorderWidth = new List<double> { 0 },
            };
        datasets.Add(dataset1);

        chartData = new ChartData { Labels = labels, Datasets = datasets };

        barChartOptions = new BarChartOptions();
        barChartOptions.Responsive = true;
        barChartOptions.Interaction = new Interaction { Mode = InteractionMode.Y };
        barChartOptions.IndexAxis = "y";

        barChartOptions.Scales.X!.Title = new ChartAxesTitle { Text = "Monto Total de Proyectos", Display = true };
        barChartOptions.Scales.Y!.Title = new ChartAxesTitle { Text = "Vendedores", Display = true };

        barChartOptions.Plugins.Legend.Display = false;

        if (barChart != null)
        {
            await barChart.InitializeAsync(chartData, barChartOptions);
            await barChart.UpdateAsync(chartData, barChartOptions);
        }
    }

    private async Task OnYearChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var year))
        {
            selectedYear = year;
            await UpdateChartAsync();
        }
    }
}
