
@inject ProjectsDBContext db

<h6>
    Monto Por Etapa @DateTime.Now.Year
</h6>
<BarChart @ref="barChart" />

@code {
    private BarChart barChart = default!;
    private BarChartOptions barChartOptions = default!;
    private ChartData chartData = default!;

    private List<string> GetLabelsStates()
    {
        // Obtener nombres de estados
        return db.States.Select(w => w.StateName).ToList();
    }

    private List<double?> GetAmountsByState(List<string> states)
    {
        // Obtener todos los proyectos y convertir a una lista en memoria
        var projects = db.Projects.AsNoTracking().Where(e=>e.CreationDate.Year== DateTime.Now.Year).ToList();

        // Obtener todos los estados y convertir a una lista en memoria
        var stateList = db.States.ToList();

        // Crear un diccionario que mapea StateId a la suma de amounts
        var projectAmountsByState = projects
            .GroupBy(p => p.StateId) // Agrupar proyectos por StateId
            .ToDictionary(
                g => g.Key, // La clave es StateId
                g => (double?)g.Sum(p => p.Amount) // La suma de amounts como double?
            );

        // Crear un diccionario que mapea el nombre del estado a StateId
        var stateIds = stateList
            .Where(s => states.Contains(s.StateName)) // Filtrar estados que están en la lista de estados
            .ToDictionary(
                s => s.StateName, // La clave es el nombre del estado
                s => s.StateId // El valor es el StateId
            );

        // Crear la lista de amounts basada en los StateIds
        var values = states
            .Select(state =>
            {
                // Obtener el StateId para el nombre del estado
                if (stateIds.TryGetValue(state, out var stateId))
                {
                    // Obtener el amount total para el StateId
                    return projectAmountsByState.TryGetValue(stateId, out var amount) ? amount : (double?)null;
                }
                return (double?)null; // Si no se encuentra el StateId, devolver null
            })
            .ToList();

        return values;
    }

    protected override void OnInitialized()
    {
        var labels = GetLabelsStates();
        var datasets = new List<IChartDataset>();

        var dataset1 = new BarChartDataset()
            {
                Data = GetAmountsByState(labels), // Usar el método actualizado
                BackgroundColor = new List<string> { ColorUtility.CategoricalTwelveColors[0] },
                BorderColor = new List<string> { ColorUtility.CategoricalTwelveColors[0] },
                BorderWidth = new List<double> { 0 },
            };
        datasets.Add(dataset1);

        chartData = new ChartData { Labels = labels, Datasets = datasets };

        barChartOptions = new BarChartOptions
            {
                Responsive = true,
                Interaction = new Interaction { Mode = InteractionMode.Y },
                IndexAxis = "y",
                Scales = new Scales
                {
                    X = new ChartAxes
                    {
                        Title = new ChartAxesTitle { Text = "Amount", Display = true }
                    },
                    Y = new ChartAxes
                    {
                        Title = new ChartAxesTitle { Text = "Etapa", Display = true }
                    }
                }
            };
        barChartOptions.Scales.X.Stacked = true;
        barChartOptions.Scales.Y.Stacked = true;
        barChartOptions.Plugins.Title!.Text = "";
        barChartOptions.Plugins.Title.Display = true;

    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await barChart.InitializeAsync(chartData, barChartOptions);
        }
        await base.OnAfterRenderAsync(firstRender);
    }
}
