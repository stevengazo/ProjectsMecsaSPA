@inject ProjectsDBContext db

@inject IJSRuntime JS



<div class="d-flex justify-content-between align-items-center mb-3">
    <button class="btn btn-outline-primary" @onclick="PrevWeek">⟨ Semana anterior</button>

    <h4 class="mb-0">
        Semana del @CurrentMonday.ToString("dd MMM yyyy") al @CurrentMonday.AddDays(6).ToString("dd MMM yyyy")
    </h4>

    <button class="btn btn-outline-primary" @onclick="NextWeek">Semana siguiente ⟩</button>
</div>

<table class="table table-bordered table-striped">
    <thead class="table-light">
        <tr>
            <th>Empleado</th>
            @foreach (var day in weekDays)
            {
                <th>@day.ToString("dddd")<br /><small>@day.ToString("dd/MM")</small></th>
            }
        </tr>
    </thead>

    <tbody>
        @foreach (var employee in employees)
        {
            var itemsByEmployee = Schedules
            .Where(s => s.SchEmpls.Any(se => se.EmployeeId == employee.EmployeeId))
            .ToList();

            <tr>
                <td><strong>@employee.FirstName @employee.LastName</strong>
                    - @if (employee.Position.Equals("Tecnico"))
                    {
                        <label>Tecnico</label>
                                        }
                </td>

                @foreach (var day in weekDays)
                {
                    var dayItems = itemsByEmployee
                    .Where(s => s.Start.Date <= day.Date && s.End.Date >= day.Date)
                    .ToList();

                    <td class="align-top">
                        @if (dayItems.Count == 0)
                        {
                            <span class="text-muted">-</span>
                        }
                        else
                        {
                            @foreach (var sched in dayItems)
                            {
                                <div class="mb-2 p-1 border-bottom small">

                                    <div class="fw-bold">
                                        @sched.Project?.ProjectId - @sched.Project?.Title
                                    </div>

                                    <div>
                                        @sched.Project?.Province
                                    </div>

                                    <div>
                                        @sched.Project?.Type?.Name
                                    </div>

                                    <div>
                                        Vehículo: @sched.Car
                                    </div>

                                </div>
                            }
                        }
                    </td>


                }
            </tr>
        }
    </tbody>
</table>

@code {
    [Parameter]
    public List<Schedule> Schedules { get; set; } = new();

    private List<Employee> employees = new();
    private List<DateTime> weekDays = new();

    private DateTime CurrentMonday;

    protected override void OnParametersSet()
    {
        // Obtener empleados únicos
        employees = Schedules
           .SelectMany(s => s.SchEmpls.Select(se => se.Employee))
           .DistinctBy(e => e.EmployeeId)     
           .ToList();

        // Si es primera carga: calcular lunes actual
        if (CurrentMonday == default)
            CurrentMonday = GetMonday(DateTime.Today);

        BuildWeek(CurrentMonday);

        base.OnParametersSet();
    }

    // ============
    //  LÓGICA DE SEMANAS
    // ============

    private DateTime GetMonday(DateTime date)
    {
        int diff = (7 + (date.DayOfWeek - DayOfWeek.Monday)) % 7;
        return date.AddDays(-diff);
    }

    private void BuildWeek(DateTime monday)
    {
        weekDays = Enumerable.Range(0, 7).Select(i => monday.AddDays(i)).ToList();
    }

    private void PrevWeek()
    {
        CurrentMonday = CurrentMonday.AddDays(-7);
        BuildWeek(CurrentMonday);
    }

    private void NextWeek()
    {
        CurrentMonday = CurrentMonday.AddDays(7);
        BuildWeek(CurrentMonday);
    }

   /* // Genera y descarga el reporte
    private async Task DownloadReportAsync()
    {
        
       // var data =  agrega la imagen
      //  var pdfBase64 = Convert.ToBase64String(data);

        // Invocar una función JavaScript para iniciar la descarga del PDF
        await JS.InvokeVoidAsync("downloadpdf", pdfBase64, $"Calendario_{DateTime.Now:yyyyMMdd_HHmm}.jpg");
    }*/

}
